<!DOCTYPE html><html lang="en" data-theme="lofi"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/jpeg" href="/tech/profile.jpg"><meta name="generator" content="Astro v4.4.15"><!-- Primary Meta Tags --><title>Python + Go: Examples | Kieran Wood</title><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><meta name="title" content="Python + Go: Examples"><meta name="description" content="Real examples of This method in action"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://kieranwood.ca/tech/blog/python-plus-go-examples/"><meta property="og:title" content="Python + Go: Examples"><meta property="og:description" content="Real examples of This method in action"><meta property="og:image" content="https://kieranwood.ca/tech/blog/python-plus-go/diagram.excalidraw.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://kieranwood.ca/tech/blog/python-plus-go-examples/"><meta property="twitter:title" content="Python + Go: Examples"><meta property="twitter:description" content="Real examples of This method in action"><meta property="twitter:image" content="https://kieranwood.ca/tech/blog/python-plus-go/diagram.excalidraw.png"><link rel="stylesheet" href="/tech/_astro/_page_.D_l8DYJv.css" />
<style>.time-line-container>div:last-child .education__time>.education__line{display:none}details{background:#f0f0f0;padding:1rem;border-radius:.7rem;margin:.5rem auto;width:100%}summary{cursor:pointer}#TOC-list{list-style:none}#TOC-list li{margin-top:.15rem}.danger-banner{display:flex;flex-direction:row;background:#f44336;border-radius:.25rem;padding:1.1rem;color:#fff!important;flex-wrap:wrap}.danger-banner strong,.danger-banner a{color:#fff!important}.danger-banner:before{content:"!üõë Danger üõë!";flex-basis:100%;margin-bottom:.5rem;padding:.6rem;border-radius:.25rem;text-align:center;background:red;text-transform:uppercase}.warning-banner{display:flex;flex-direction:row;background:#fcc51e;border-radius:.25rem;padding:1.1rem;color:#141414!important;flex-wrap:wrap}.warning-banner strong,.warning-banner a{color:#141414!important}.warning-banner:before{content:"üü° Warning üü°";flex-basis:100%;margin-bottom:.5rem;padding:.6rem;border-radius:.25rem;text-align:center;background:#f6cb49;text-transform:uppercase;text-shadow:1px 1px 1px rgb(93,93,93)}.level-3{text-indent:1rem}.level-4{text-indent:2rem}.level-5{text-indent:3rem}.level-6{text-indent:4rem}.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);-webkit-clip-path:inset(50%);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
</style><script type="module" src="/tech/_astro/hoisted.CHePpst8.js"></script><style>[data-astro-transition-scope="astro-vz7ejtmd-1"] { view-transition-name: __2ftech_2fblog_2fpython-plus-go_2fdiagram_2eexcalidraw_2epng; }</style><style>[data-astro-transition-scope="astro-frvnq75b-2"] { view-transition-name: Python_20_2b_20Go_3a_20Examples; }</style></head> <body> <div class="bg-base-100 drawer lg:drawer-open"> <input id="my-drawer" type="checkbox" class="drawer-toggle"> <div class="drawer-content bg-base-100"> <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm"> <div class="navbar"> <div class="navbar-start"> <label for="my-drawer" class="btn btn-square btn-ghost"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path> </svg> </label> </div> <div class="navbar-center"> <a class="btn btn-ghost normal-case text-xl" href="/">Kieran Wood ‚ö°Ô∏è</a> </div> <div class="navbar-end"></div> </div> </div> <div class="md:flex md:justify-center"> <main class="p-6 pt-10 lg:max-w-[900px] max-w-[100vw]">  <main class="md:flex md:justify-center"> <article class="prose prose-lg max-w-[750px] prose-img:mx-auto"> <img src="/tech/blog/python-plus-go/diagram.excalidraw.png" alt="Python + Go: Examples" class="w-full mb-6" style="border-radius:.5em" data-astro-transition-scope="astro-vz7ejtmd-1" width="750" height="422" loading="lazy" decoding="async"> <h1 class="title my-2 text-4xl font-bold" data-astro-transition-scope="astro-frvnq75b-2">Python + Go: Examples</h1> <time>May 19, 2025</time> <br>  <a href="/blog/tag/python" class="badge badge-outline ml-2 no-underline"> python </a><a href="/blog/tag/go" class="badge badge-outline ml-2 no-underline"> go </a><a href="/blog/tag/C" class="badge badge-outline ml-2 no-underline"> C </a><a href="/blog/tag/web" class="badge badge-outline ml-2 no-underline"> web </a><a href="/blog/tag/theory" class="badge badge-outline ml-2 no-underline"> theory </a><a href="/blog/tag/packages" class="badge badge-outline ml-2 no-underline"> packages </a>   <div class="divider my-2"></div> <div> <h2>Table of contents</h2> <ul id="TOC-list"> <li class="level-2"> <a href="#helpers" class="no-underline"> Helpers </a> </li><li class="level-3"> <a href="#array-functions" class="no-underline"> Array functions </a> </li><li class="level-3"> <a href="#c-types" class="no-underline"> C Types </a> </li><li class="level-3"> <a href="#pinning" class="no-underline"> Pinning </a> </li><li class="level-2"> <a href="#site-scraper" class="no-underline"> Site Scraper </a> </li><li class="level-3"> <a href="#the-emotional-toll" class="no-underline"> The emotional toll </a> </li><li class="level-2"> <a href="#spell-check" class="no-underline"> Spell Check </a> </li><li class="level-3"> <a href="#windows-dangers" class="no-underline"> Windows Dangers </a> </li><li class="level-2"> <a href="#practical-tips" class="no-underline"> Practical tips </a> </li><li class="level-2"> <a href="#conclusions" class="no-underline"> Conclusions </a> </li> </ul> </div>
  <hr><p>We made it, we finally made it to the last article. If you haven‚Äôt yet, please read the last two articles to get up to speed, I‚Äôm not re-covering anything from them:</p>
<ul>
<li><a href="https://kieranwood.ca/tech/blog/python-plus-go-intro">Python + Go Intro</a></li>
<li><a href="https://kieranwood.ca/tech/blog/python-plus-go-basics">Python + Go Basics</a></li>
</ul>
<p>First, I want to give you a warning of when you <strong>shouldn‚Äôt</strong> do this. In general the useful examples I wrote were ones that were:</p>
<ul>
<li><strong>CPU bound</strong>: if you‚Äôre mostly dealing with I/O, both languages are pretty good at it. This method really shines when the computation itself is the bottleneck.</li>
<li><strong>Highly Concurrent</strong>: Tasks that are <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel#:~:text=In%20parallel%20computing%2C%20an%20embarrassingly,a%20number%20of%20parallel%20tasks.">embarassingly parallel</a> come to mind, but in general Go is built to handle concurrency well compared to python and as such, anything that uses a bunch of concurrency will benefit from being in go</li>
<li><strong>High Memory Budget</strong>: All of the methods I describe in here aschew memory for execution time. To keep things safe and ‚Äúsimple‚Äù most data is copied between the environments, meaning multiple copies of variables exist in each runtime, you could avoid these issues with shared-memory approaches (<a href="https://en.wikipedia.org/wiki/Message_passing">message passing</a>, file i/o, databases, etc.), but I didn‚Äôt bother for these examples</li>
</ul>
<p>I do want to mention that although I warned about it before it‚Äôs worth mentioning that writing this sort of code in practicallity takes understanding Go, and Python well, and a bit of C/memory management fundamentals. The demos in this article are no different.</p>
<p>I had originally planned to post this article a day after the last, but if you check the dates, it‚Äôs been over a week since then. Turns out this code is harder to do than I first thought. With that out of the way, now we ‚Äúknow what we‚Äôre doing‚Äù, what are some examples of this done in a way that‚Äôs usable for other people?</p>
<h2 id="helpers">Helpers</h2>
<p>Because there was so much to remember I actually ended up putting together a helper library to make developing both the go and python side ‚Äúeasier‚Äù (none of this stuff is easy). Though, it‚Äôs worth mentioning I went safety over performance, so there are many situation-specific optimizations where rolling your own code is more worthwhile (like dealing with bytes directly). Another shortcoming is structs, there was no way to deal with generic structs nicely, so you‚Äôll need to do that manually. I have the code for each example using it, and without it. Here is a diagram with the rundown of the basics:</p>
<p><img src="/tech/blog/python-plus-go/helper-layout.excalidraw.png" alt=""></p>
<p>You can then use these functions to as the library to do the data binding between python and Go, and you just need to build out YOUR api (your go and python side) using the helper library. I will have a separate <a href="https://github.com/Descent098/cgo-python-helpers">git repo</a> with up to date code, and eventually a <a href="https://kieranwood.ca/cgo-python-helpers/">web app</a> to help make this process smoother.</p>
<p>If you want the current source code as of writting, here it is, but please be aware, I have done as much due diligence as I can to detect memory leaks, but lots of behaviours are 1. not documented, and 2. not trivial to diagnose, use at your own risk.</p>
<details><summary>Source code (Hidden for brevity)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// # Functions</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Convert C types to go types (internal; Use at entrypoint to Go libraries)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	CStringToString(input *C.char) string{} //Convert a string to a c-compatible C-string (glorified alias for C.GoString)</span></span>
<span class="line"><span style="color:#6A737D">//	CFloatArrayToSlice(cArray *C.float, length int) []float32{} // Converts a C array of floats to a slice of floats</span></span>
<span class="line"><span style="color:#6A737D">//	CIntArrayToSlice(cArray *C.int, length int) []int{} // Takes a C integer array and coverts it to an integer slice</span></span>
<span class="line"><span style="color:#6A737D">//	CStringArrayToSlice(cArray **C.char, numberOfStrings int) []string{} // Takes in an array of strings, and converts it to a slice of strings</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Convert Go types to C types (external; Use to prep data to return to C)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	StringToCString(data string) *C.char{} // Convert a string to a c-compatible C-string (glorified alias for C.CString)</span></span>
<span class="line"><span style="color:#6A737D">//	StringSliceToCArray(data []string) *C.StringArrayResult{} // Return dynamically sized string array as a C-Compatible array</span></span>
<span class="line"><span style="color:#6A737D">//	IntSliceToCArray(data []int) *C.IntArrayResult{} // Return dynamically sized int array as a C-Compatible array</span></span>
<span class="line"><span style="color:#6A737D">//	FloatSliceToCArray(data []float32) *C.FloatArrayResult{} // Return dynamically float sized array as a C-Compatible array</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Memory Freeing</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	FreeCString(data *C.char){} // Free's a C-string</span></span>
<span class="line"><span style="color:#6A737D">//	FreeStringArray(inputArray **C.char, count C.int){} // Free's an array of strings</span></span>
<span class="line"><span style="color:#6A737D">//	FreeIntArray(ptr *C.int){}  // Free's an array of integers</span></span>
<span class="line"><span style="color:#6A737D">//	FreeFloatArray(ptr *C.float){} // Free's an array of floats</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Debugging Functions</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	return_string(data *C.char) *C.char{} // Used to convert a C-compatible string to a C-compatible string, useful for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//	return_string_array(cArray **C.char, numberOfStrings int) *C.StringArrayResult{} // Used to convert a C-compatible string array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//	return_int_array(cArray *C.int, numberOfElements C.int) *C.IntArrayResult{} // Used to convert a C-compatible integer array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//	return_float_array(cArray *C.float, numberOfElements C.int) *C.FloatArrayResult{} // Used to convert a C-compatible float array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//	print_string(ptr *C.char){} // Prints the go representation of a C string, good for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//	print_string_array(cArray **C.char, numberOfString int){} // Prints the go representation of an array, good for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//	print_int_array(cArray *C.int, numberOfInts int){} // Prints the go representation of an array, good for debugging rounding/conversion issues</span></span>
<span class="line"><span style="color:#6A737D">//	print_float_array(cArray *C.float, numberOfFloats int){} // Prints the go representation of an array, good for debugging rounding/conversion issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Examples</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Create a function to show the internal go representation of an array of strings</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	 // Takes in a C string array, prints the go representation, then returns it</span></span>
<span class="line"><span style="color:#6A737D">//	 //export print_string_array</span></span>
<span class="line"><span style="color:#6A737D">//	 func print_string_array(cArray **C.char, numberOfStrings int) *C.StringArrayResult {</span></span>
<span class="line"><span style="color:#6A737D">//		  internalRepresentation := CStringArrayToSlice(cArray, numberOfStrings)</span></span>
<span class="line"><span style="color:#6A737D">//		  fmt.Printf("return_string_array() Go representation: %v\n", internalRepresentation)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//		  result := StringSliceToCArray(internalRepresentation)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//		  return result</span></span>
<span class="line"><span style="color:#6A737D">//	 }</span></span>
<span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct{</span></span>
<span class="line"><span style="color:#6A737D">	int numberOfElements;</span></span>
<span class="line"><span style="color:#6A737D">	char** data;</span></span>
<span class="line"><span style="color:#6A737D">} StringArrayResult;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct {</span></span>
<span class="line"><span style="color:#6A737D">    int numberOfElements;</span></span>
<span class="line"><span style="color:#6A737D">    int* data;</span></span>
<span class="line"><span style="color:#6A737D">} IntArrayResult;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct {</span></span>
<span class="line"><span style="color:#6A737D">    int numberOfElements;</span></span>
<span class="line"><span style="color:#6A737D">    float* data;</span></span>
<span class="line"><span style="color:#6A737D">} FloatArrayResult;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">unsafe</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ======== Convert Go types to C type ========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Convert a string to a c-compatible C-string (glorified alias for C.CString)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - input: The Go string to convert.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - A pointer to the newly allocated C string (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using FreeCString.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> StringToCString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">input</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(input))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function to take a slice and convert it to a StringArrayResult to be returned to C code</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - data: Slice of Go strings to convert.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.StringArrayResult containing the converted C strings.</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_string_array_result.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> StringSliceToCArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	count </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for an array of C string pointers (char**)</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfElements </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> amountOfElements </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfSingleElement</span></span>
<span class="line"><span style="color:#E1E4E8">	stringArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#E1E4E8">C.char)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, currentString </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> data {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(stringArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                           </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))        </span><span style="color:#6A737D">// Size of a single string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#E1E4E8">C.char)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfSingleElement))</span></span>
<span class="line"><span style="color:#F97583">		*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(currentString) </span><span style="color:#6A737D">// Convert go string to C string and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for the struct</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.StringArrayResult)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringArrayResult</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"><span style="color:#E1E4E8">	result.numberOfElements </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">	result.data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> stringArray</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Return dynamically sized int array as a C-Compatible array</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - data: Slice of Go integers to convert.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.IntArrayResult containing the converted C integers.</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_int_array_result.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> IntSliceToCArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IntArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	count </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory in C for the int array</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Fill in the values</span></span>
<span class="line"><span style="color:#E1E4E8">	array </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">]C.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray))</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, val </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> data {</span></span>
<span class="line"><span style="color:#E1E4E8">		array[i] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(val)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate the result struct</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.IntArrayResult)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IntArrayResult</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"><span style="color:#E1E4E8">	result.numberOfElements </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">	result.data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cArray</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Return dynamically float sized array as a C-Compatible array</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - data: Slice of Go float32 values to convert.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.FloatArrayResult containing the converted C floats.</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_float_array_result.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FloatSliceToCArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">float32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FloatArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	count </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory in C for the float array</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">float</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.float)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Fill in the values</span></span>
<span class="line"><span style="color:#E1E4E8">	array </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">]C.float)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray))</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, val </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> data {</span></span>
<span class="line"><span style="color:#E1E4E8">		array[i] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">float</span><span style="color:#E1E4E8">(val)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate the result struct</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.FloatArrayResult)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FloatArrayResult</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"><span style="color:#E1E4E8">	result.numberOfElements </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">	result.data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cArray</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ======== Convert C types to Go ========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Convert a string to a c-compatible C-string (glorified alias for C.GoString)</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - input: Pointer to the C string to convert (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - The corresponding Go string.</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CStringToString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">input</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">((</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.char)(input))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Takes a C integer array and coverts it to an integer slice</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of integers (*C.int).</span></span>
<span class="line"><span style="color:#6A737D">//   - length: Number of elements in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - A Go slice containing the converted integers.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Usage:</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	var cIntArray *C.int // Assuming it's set in some line after this</span></span>
<span class="line"><span style="color:#6A737D">//	goInts := CIntArrayToSlice(unsafe.Pointer(cIntArray), length)</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CIntArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">length</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Setup buffer for array contents</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#E1E4E8"> bufferSize </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#6A737D"> // Allocate a huge buffer</span></span>
<span class="line"><span style="color:#E1E4E8">	slice </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[bufferSize]</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(cArray)[:length:length]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Convert to []int</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, length)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> length; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		result[i] </span><span style="color:#F97583">=</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(slice[i])</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Converts a C array of floats to a slice of floats</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of floats (*C.float).</span></span>
<span class="line"><span style="color:#6A737D">//   - length: Number of elements in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - A Go slice containing the converted float32 values.r</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Usage:</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//	var cFloatArray  *C.float // Assuming it's set in some line after this</span></span>
<span class="line"><span style="color:#6A737D">//	goFloats := CFloatArrayToSlice(unsafe.Pointer(cFloatArray), length)</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CFloatArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">length</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">float32</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Setup buffer for array contents</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#E1E4E8"> bufferSize </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#6A737D"> // Allocate a huge buffer</span></span>
<span class="line"><span style="color:#E1E4E8">	slice </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[bufferSize]</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">float</span><span style="color:#E1E4E8">)(cArray)[:length:length]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Convert to []float32</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">float32</span><span style="color:#E1E4E8">, length)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> length; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		result[i] </span><span style="color:#F97583">=</span><span style="color:#F97583"> float32</span><span style="color:#E1E4E8">(slice[i])</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Takes in an array of strings, and converts it to a slice of strings</span></span>
<span class="line"><span style="color:#6A737D">// C array -> slice of strings</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of strings (**C.char).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfStrings: Number of strings in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - A Go slice containing the converted strings.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Notes</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//   - This function DOES NOT clean memory of input array, that's up to others to clear</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfStrings</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Setup buffer for array contents</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#E1E4E8"> bufferSize </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#6A737D"> // Allocate a huge buffer</span></span>
<span class="line"><span style="color:#E1E4E8">	stringPointers </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[bufferSize]</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(cArray)[:numberOfStrings:numberOfStrings]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, numberOfStrings)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> numberOfStrings {</span></span>
<span class="line"><span style="color:#E1E4E8">		result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(result, C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(stringPointers[i]))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ========== Debugging Functions ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Used to convert a C-compatible string back to itself, good for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cString: Pointer to the C string (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a new C string with the same content (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using FreeCString.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export return_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> return_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cString</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	internalRepresentation </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">((</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.char)(cString))</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> StringToCString</span><span style="color:#E1E4E8">(internalRepresentation)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Used to convert a C-compatible string array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of strings (**C.char).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfStrings: Number of strings in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.StringArrayResult containing the converted strings (*C.StringArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_string_array_result.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export return_string_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> return_string_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfStrings</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	internalRepresentation </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(cArray, numberOfStrings)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> StringSliceToCArray</span><span style="color:#E1E4E8">(internalRepresentation)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Used to convert a C-compatible integer array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of integers (*C.int).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfElements: Number of elements in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.IntArrayResult containing the converted integers (*C.IntArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_int_array_result.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export return_int_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> return_int_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfElements</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IntArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	internalRepresentation </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CIntArrayToSlice</span><span style="color:#E1E4E8">(cArray, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(numberOfElements))</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> IntSliceToCArray</span><span style="color:#E1E4E8">(internalRepresentation)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IntArrayResult</span><span style="color:#E1E4E8">)(result)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Used to convert a C-compatible float array to wrapper type</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of floats(*C.float).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfElements: Number of elements in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Returns:</span></span>
<span class="line"><span style="color:#6A737D">//   - Pointer to a C.FloatArrayResult containing the converted floats (*C.FloatArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//     Note: The caller is responsible for freeing the allocated memory using free_float_array_result.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export return_float_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> return_float_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfElements</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FloatArrayResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	internalRepresentation </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CFloatArrayToSlice</span><span style="color:#E1E4E8">(cArray, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(numberOfElements))</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> FloatSliceToCArray</span><span style="color:#E1E4E8">(internalRepresentation)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FloatArrayResult</span><span style="color:#E1E4E8">)(result)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Prints the go representation of a C string, good for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - ptr: Pointer to the C string (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export print_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> print_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> ptr </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"print_string() Go representation: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">((</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.char)(ptr)))</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"print_string() received nil pointer"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Prints the go representation of an array, good for debugging encoding issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of strings (**C.char).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfString: Number of strings in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export print_string_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> print_string_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfString</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(cArray, numberOfString)</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"print_string_array() Go representation: </span><span style="color:#79B8FF">%v\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, res)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Prints the go representation of an array, good for debugging rounding/conversion issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of integers (*C.int).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfInts: Number of integers in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export print_int_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> print_int_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfInts</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Got initial array with </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF"> items, converting"</span><span style="color:#E1E4E8">, numberOfInts)</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CIntArrayToSlice</span><span style="color:#E1E4E8">(cArray, numberOfInts)</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Converted array"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"print_int_array() Go representation: </span><span style="color:#79B8FF">%v\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, res)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Prints the go representation of an array, good for debugging rounding/conversion issues</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - cArray: Pointer to the C array of floats (*C.float).</span></span>
<span class="line"><span style="color:#6A737D">//   - numberOfFloats: Number of floats in the C array.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export print_float_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> print_float_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfFloats</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CFloatArrayToSlice</span><span style="color:#E1E4E8">(cArray, numberOfFloats)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"print_float_array() Go representation: </span><span style="color:#79B8FF">%v\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, res)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ========== Functions to free memory ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a previously allocated C string from Go.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - ptr: Pointer to the C string to be freed (*C.char).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export FreeCString</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FreeCString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> ptr </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(ptr)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a StringArrayResult allocated by StringSliceToCArray.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the C.StringArrayResult to be freed (**C.char).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export FreeStringArray</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FreeStringArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(count); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to find the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(inputArray)          </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                   </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		memorySizeOfStruct </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)) </span><span style="color:#6A737D">// Size of a single struct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		ptr </span><span style="color:#F97583">:=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">**</span><span style="color:#E1E4E8">C.char)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">memorySizeOfStruct))</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(ptr))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(inputArray)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free an *C.int.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the *C.int to be freed.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export FreeIntArray</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FreeIntArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(ptr)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a *C.float.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the C.FloatArrayResult to be freed (*C.float).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export FreeFloatArray</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FreeFloatArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(ptr)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a *C.StringArrayResult.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the C.StringArrayResult to be freed (*C.StringArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export free_string_array_result</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_string_array_result</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">StringArrayResultReference</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	temp </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringArrayResult</span><span style="color:#E1E4E8">)(StringArrayResultReference)</span></span>
<span class="line"><span style="color:#B392F0">	FreeStringArray</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(temp.data), temp.numberOfElements)</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(StringArrayResultReference))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a *C.IntArrayResult.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the C.IntArrayResult to be freed (*C.IntArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export free_int_array_result</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_int_array_result</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	temp </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IntArrayResult</span><span style="color:#E1E4E8">)(ptr)</span></span>
<span class="line"><span style="color:#B392F0">	FreeIntArray</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(temp.data))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(ptr))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Free a *C.FloatArrayResult.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// Parameters:</span></span>
<span class="line"><span style="color:#6A737D">//   - result: Pointer to the C.FloatArrayResult to be freed (*C.FloatArrayResult).</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export free_float_array_result</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_float_array_result</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ptr</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	temp </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FloatArrayResult</span><span style="color:#E1E4E8">)(ptr)</span></span>
<span class="line"><span style="color:#B392F0">	FreeFloatArray</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(temp.data))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(ptr))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {}</span></span></code></pre>
<p><code>lib.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#9ECBFF">"""A package to help with building Go-python libraries"""</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> os</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> subprocess</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#79B8FF"> CDLL</span><span style="color:#E1E4E8">, Array, cdll, c_char_p, c_int, </span><span style="color:#79B8FF">POINTER</span><span style="color:#E1E4E8">, c_float, Structure, string_at </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Helper Functions  ============</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> get_library</span><span style="color:#E1E4E8">(dll_path:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">,source_path:</span><span style="color:#79B8FF">str</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">, compile:</span><span style="color:#79B8FF">bool</span><span style="color:#F97583">=</span><span style="color:#79B8FF">False</span><span style="color:#E1E4E8">) -> </span><span style="color:#79B8FF">CDLL</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Get's the DLL specified, will compile if not found and flag is specified</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    dll_path : str</span></span>
<span class="line"><span style="color:#9ECBFF">        The path to the DLL file, if compile is specified this will be the output path</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    source_path:str, optional</span></span>
<span class="line"><span style="color:#9ECBFF">        The path to the source go file, only needed if compile is true, by default ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    compile : bool, optional</span></span>
<span class="line"><span style="color:#9ECBFF">        Specify if you should try to compile DLL if not in path, by default False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Raises</span></span>
<span class="line"><span style="color:#9ECBFF">    ------</span></span>
<span class="line"><span style="color:#9ECBFF">    ValueError:</span></span>
<span class="line"><span style="color:#9ECBFF">        If linked library is not available and/or compilable (if compile is specified)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    CDLL</span></span>
<span class="line"><span style="color:#9ECBFF">        The linked library</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    Build similarity.dll/similarity.so from lib.go</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    from platform import platform</span></span>
<span class="line"><span style="color:#9ECBFF">    # import library</span></span>
<span class="line"><span style="color:#9ECBFF">    if platform().lower().startswith("windows"):</span></span>
<span class="line"><span style="color:#9ECBFF">        library_location = os.path.join(os.path.dirname(os.path.realpath(__file__)), "similarity.dll")</span></span>
<span class="line"><span style="color:#9ECBFF">    else:</span></span>
<span class="line"><span style="color:#9ECBFF">        library_location = os.path.join(os.path.dirname(os.path.realpath(__file__)), "similarity.so")</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    source_location = os.path.join(os.path.dirname(os.path.realpath(__file__)), "lib.go")</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    lib = get_library(library_location, source_location, compile=True)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> os.path.exists(dll_path):</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> not</span><span style="color:#79B8FF"> compile</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Linked Library is not available: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">dll_path</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">            additional_flags </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "set GOTRACEBACK=system &#x26;&#x26;"</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">            additional_flags </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "env GOTRACEBACK=system"</span></span>
<span class="line"><span style="color:#E1E4E8">        command </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">additional_flags</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> go build -ldflags </span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">-s -w</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF"> -buildmode=c-shared -o </span><span style="color:#79B8FF">\"{</span><span style="color:#E1E4E8">dll_path</span><span style="color:#79B8FF">}\"</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> compile</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">            print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">Required shared library is not available, building..."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">                subprocess.run(command, </span><span style="color:#FFAB70">shell</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">check</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">cwd</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">os.path.dirname(source_path))</span></span>
<span class="line"><span style="color:#F97583">            except</span><span style="color:#79B8FF"> Exception</span><span style="color:#F97583"> as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">                if</span><span style="color:#79B8FF"> isinstance</span><span style="color:#E1E4E8">(e, </span><span style="color:#79B8FF">FileNotFoundError</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#79B8FF">                    print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Unable to find Go install, please install it and try again</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">                    print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Ran into error while trying to build shared library, make sure go, and a compatible compiler are installed, then try building manually using:</span><span style="color:#79B8FF">\n\t{</span><span style="color:#E1E4E8">command</span><span style="color:#79B8FF">}\n</span><span style="color:#9ECBFF">Exiting with error:</span><span style="color:#79B8FF">\n\t{</span><span style="color:#E1E4E8">e</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Linked Library is not available or compileable: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">dll_path</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cdll.LoadLibrary(dll_path)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== C Structs ==========</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> _CStringArrayResult</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"numberOfElements"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"data"</span><span style="color:#E1E4E8">, POINTER(c_char_p)),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> _CIntArrayResult</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"numberOfElements"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"data"</span><span style="color:#E1E4E8">, POINTER(c_int)),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> _CFloatArrayResult</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"numberOfElements"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"data"</span><span style="color:#E1E4E8">, POINTER(c_float)),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Setup CGo functions ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#E1E4E8">dll_source_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)), </span><span style="color:#9ECBFF">"lib.go"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    dll_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)),</span><span style="color:#9ECBFF">"lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> get_library(dll_file, dll_source_file, </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    dll_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)),</span><span style="color:#9ECBFF">"lib.so"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> get_library(dll_file, dll_source_file, </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.print_string_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8">  [POINTER(c_char_p), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.FreeStringArray.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_char_p), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.print_int_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8">  [POINTER(c_int), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.FreeIntArray.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.print_float_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8">  [POINTER(c_float), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.FreeFloatArray.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8">  [POINTER(c_float)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.return_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.return_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.FreeCString.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.print_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">## ========== Array-based functions ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.FreeStringArray.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_char_p), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string_array_result.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(_CStringArrayResult)]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.return_string_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_char_p), c_int] </span></span>
<span class="line"><span style="color:#E1E4E8">lib.return_string_array.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(_CStringArrayResult)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.return_int_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_int), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.return_int_array.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(_CIntArrayResult)</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_int_array_result.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(_CIntArrayResult)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.return_float_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_float), c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.return_float_array.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(_CFloatArrayResult)</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_float_array_result.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(_CFloatArrayResult)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Nice Typehints/Type Aliases ==========</span></span>
<span class="line"><span style="color:#E1E4E8">CIntArray </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Array[c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">CFloatArray </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Array[c_float]</span></span>
<span class="line"><span style="color:#E1E4E8">CStringArray </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Array[c_char_p]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Python types to C ============</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> prepare_string</span><span style="color:#E1E4E8">(data: </span><span style="color:#79B8FF">str</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> bytes</span><span style="color:#E1E4E8">) -> c_char_p:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in a string and returns a C-compatible string</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does not prune null terminators (</span><span style="color:#79B8FF">\\</span><span style="color:#9ECBFF">0 characters)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : str | bytes</span></span>
<span class="line"><span style="color:#9ECBFF">        The string to prepare</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    c_char_p</span></span>
<span class="line"><span style="color:#9ECBFF">        The resulting pointer to the string</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> data:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> c_char_p(</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> type</span><span style="color:#E1E4E8">(data) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> c_char_p(data.encode())</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> c_char_p(</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">(data))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> prepare_string_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">str</span><span style="color:#F97583">|</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">]) -> tuple[CStringArray, </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in a string list, and converts it to a C-compatible array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[str | bytes]</span></span>
<span class="line"><span style="color:#9ECBFF">        The list to convert</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    Array[c_char_p], int</span></span>
<span class="line"><span style="color:#9ECBFF">        The resulting array, and the number of items</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Because the data is allocated in python, python will free the memory afterwords</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does not prune null terminators (</span><span style="color:#79B8FF">\\</span><span style="color:#9ECBFF">0 characters)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    lib = cdll.LoadLibrary("path/to/library.dll") # Load Library</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Function that takes in string array, and number of items, then prints them in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_string_array.argtypes =  [POINTER(c_char_p), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Prep data using function</span></span>
<span class="line"><span style="color:#9ECBFF">    data = ["Hello", "World", "!"]</span></span>
<span class="line"><span style="color:#9ECBFF">    c_array, number_of_items = prepare_string_array(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Use data in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_string_array(c_array, number_of_items)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#6A737D">    # Encode items to bytes</span></span>
<span class="line"><span style="color:#E1E4E8">    data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">            c_char_p(item.encode())</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> type</span><span style="color:#E1E4E8">(item) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> str</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#E1E4E8">            c_char_p(</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">(item))</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> item </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data</span></span>
<span class="line"><span style="color:#E1E4E8">    ] </span></span>
<span class="line"><span style="color:#E1E4E8">    number_of_items </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"><span style="color:#E1E4E8">    array_type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> number_of_items </span><span style="color:#6A737D"># Create a C array of char* (aka **char)</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> array_type(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">data)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> c_array, number_of_items</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> prepare_int_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]) -> tuple[CIntArray, </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in an int list, and converts it to a C-compatible array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[int]</span></span>
<span class="line"><span style="color:#9ECBFF">        The list of integers to convert to an array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    Array[c_int], int</span></span>
<span class="line"><span style="color:#9ECBFF">        The resulting array, and the number of items</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Because the data is allocated in python, python will free the memory afterwords</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    lib = cdll.LoadLibrary("path/to/library.dll") # Load Library</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Function that takes in int array, and number of items, then prints them in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_int_array.argtypes =  [POINTER(c_int), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Prep data using function</span></span>
<span class="line"><span style="color:#9ECBFF">    data = [1,2,3,4]</span></span>
<span class="line"><span style="color:#9ECBFF">    c_array, number_of_items = prepare_int_array(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Use data in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_int_array(c_array, number_of_items)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int(item) </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> item </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data] </span><span style="color:#6A737D"># Force an error if wrong type</span></span>
<span class="line"><span style="color:#E1E4E8">    number_of_items </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"><span style="color:#E1E4E8">    array_type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_int </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> number_of_items </span><span style="color:#6A737D"># Create a C array of int*</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> array_type(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">data)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> c_array, number_of_items</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> prepare_float_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">float</span><span style="color:#E1E4E8">]) -> tuple[CFloatArray, </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in an float list, and converts it to a C-compatible array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[float]</span></span>
<span class="line"><span style="color:#9ECBFF">        The list of integers to convert to an array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    Array[c_float], int</span></span>
<span class="line"><span style="color:#9ECBFF">        The resulting array, and the number of items</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Because the data is allocated in python, python will free the memory afterwords</span></span>
<span class="line"><span style="color:#9ECBFF">    - The data is only accurate up to ~4 decimals (i.e. if value is -790.5207366698761 you might get -790.520751953125)</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    lib = cdll.LoadLibrary("path/to/library.dll") # Load Library</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Function that takes in float array, and number of items, then prints them in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_float_array.argtypes =  [POINTER(c_float), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Prep data using function</span></span>
<span class="line"><span style="color:#9ECBFF">    data = [1.0,2.604,3.14159,4.964]</span></span>
<span class="line"><span style="color:#9ECBFF">    c_array, number_of_items = prepare_float_array(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    # Use data in C</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.print_float_array(c_array, number_of_items)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_float(item) </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> item </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data]  </span><span style="color:#6A737D"># Force an error if wrong type</span></span>
<span class="line"><span style="color:#E1E4E8">    number_of_items </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(data)</span></span>
<span class="line"><span style="color:#E1E4E8">    array_type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_float </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> number_of_items </span><span style="color:#6A737D"># Create a C array of float*</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> array_type(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">data)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> c_array, number_of_items</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Convert C types to python ============</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> string_to_str</span><span style="color:#E1E4E8">(pointer: c_char_p) -> </span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in a pointer to a C string and returns a Python string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    pointer : c_char_p</span></span>
<span class="line"><span style="color:#9ECBFF">        A C-style string pointer returned from Go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Assumes the pointer is a valid null-terminated UTF-8 encoded string</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does NOT free the pointer automatically, you must call `lib.FreeCString(pointer)` if needed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    str</span></span>
<span class="line"><span style="color:#9ECBFF">        The decoded Python string representation of the C string</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    c_str = prepare_string(b"Hello from Python!")</span></span>
<span class="line"><span style="color:#9ECBFF">    result: str = string_to_str(c_str)</span></span>
<span class="line"><span style="color:#9ECBFF">    lib.FreeCString(c_str)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> pointer:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> pointer.value.decode(</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> string_array_result_to_list</span><span style="color:#E1E4E8">(pointer:_CStringArrayResult) -> list[</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Takes in a pointer to a string result and returns a list of strings</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    pointer : _CStringArrayResult</span></span>
<span class="line"><span style="color:#9ECBFF">        A pointer to a CString Result</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - free's the original pointer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    list[str]</span></span>
<span class="line"><span style="color:#9ECBFF">        The list of strings the pointer pointed to</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    data = [</span></span>
<span class="line"><span style="color:#9ECBFF">        random.choice(["Lorem", "ipsum", "dolor", "sit", "amet"]) </span></span>
<span class="line"><span style="color:#9ECBFF">        for _ in range(100)</span></span>
<span class="line"><span style="color:#9ECBFF">    ]</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    c_array, number_of_elements = prepare_string_array(data)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    pointer = return_string_array(c_array, number_of_elements)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    result:list[str] = string_array_result_to_list(pointer)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#E1E4E8">        results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements):</span></span>
<span class="line"><span style="color:#E1E4E8">            results.append(result_data.data[i].decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"><span style="color:#F97583">    finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_string_array_result(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> int_array_result_to_list</span><span style="color:#E1E4E8">(pointer: _CIntArrayResult) -> list[</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Converts C int result struct to a Python list, and frees memory."""</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [result_data.data[i] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements)]</span></span>
<span class="line"><span style="color:#F97583">    finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_int_array_result(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> float_array_result_to_list</span><span style="color:#E1E4E8">(pointer: _CFloatArrayResult) -> list[</span><span style="color:#79B8FF">float</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Converts C float result struct to a Python list, and frees memory."""</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [result_data.data[i] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements)]</span></span>
<span class="line"><span style="color:#F97583">    finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_float_array_result(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Debugging Functions ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> return_string</span><span style="color:#E1E4E8">(text: </span><span style="color:#79B8FF">str</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> bytes</span><span style="color:#E1E4E8">) -> </span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Debugging function that shows you the Go representation of a C string and returns the python string version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    text : str | bytes</span></span>
<span class="line"><span style="color:#9ECBFF">        The text to get the representation of</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    str</span></span>
<span class="line"><span style="color:#9ECBFF">        The returned string</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    c_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> prepare_string(text)</span></span>
<span class="line"><span style="color:#E1E4E8">    result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.return_string(c_input)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> result:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    copied_bytes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> string_at(result)</span></span>
<span class="line"><span style="color:#E1E4E8">    decoded </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> copied_bytes.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> decoded</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> return_string_array</span><span style="color:#E1E4E8">(c_array:CStringArray, number_of_elements:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">) ->list[</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Debugging function that shows you the Go representation of a C array and returns the python list version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    c_array : Array[c_char_p]</span></span>
<span class="line"><span style="color:#9ECBFF">        The array to print and convert</span></span>
<span class="line"><span style="color:#9ECBFF">    number_of_elements : int</span></span>
<span class="line"><span style="color:#9ECBFF">        The number of elements in the array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - DOES NOT FREE INPUT ARRAY</span></span>
<span class="line"><span style="color:#9ECBFF">    - This function returns the PYTHON list version, do not reassign input variable or it'll never free (i.e. c_array = return_string_array(c_array, number_of_elements))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    list[str]</span></span>
<span class="line"><span style="color:#9ECBFF">        The python string representation of the array</span></span>
<span class="line"><span style="color:#9ECBFF">        </span></span>
<span class="line"><span style="color:#9ECBFF">    Examples</span></span>
<span class="line"><span style="color:#9ECBFF">    --------</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    data = [</span></span>
<span class="line"><span style="color:#9ECBFF">        random.choice(["Lorem", "ipsum", "dolor", "sit", "amet"]) </span></span>
<span class="line"><span style="color:#9ECBFF">        for _ in range(100)</span></span>
<span class="line"><span style="color:#9ECBFF">    ]</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    c_array, number_of_elements = prepare_string_array(data)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    result:list[str] = return_string_array(c_array, number_of_elements)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    lib.free_string_array_result(c_array, number_of_elements)</span></span>
<span class="line"><span style="color:#9ECBFF">    </span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.return_string_array(c_array, number_of_elements)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#E1E4E8">    results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements):</span></span>
<span class="line"><span style="color:#E1E4E8">        results.append(result_data.data[i].decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> return_int_array</span><span style="color:#E1E4E8">(c_array: CIntArray, number_of_elements: </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">) -> list[</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Debugging function that shows you the Go representation of a C int array and returns a Python list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - DOES NOT FREE INPUT ARRAY</span></span>
<span class="line"><span style="color:#9ECBFF">    - Frees input array ONLY on exception</span></span>
<span class="line"><span style="color:#9ECBFF">    - Returns the PYTHON list version, do not reassign input variable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    list[int]</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.return_int_array(c_array, number_of_elements)</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [result_data.data[i] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements)]</span></span>
<span class="line"><span style="color:#F97583">    except</span><span style="color:#79B8FF"> Exception</span><span style="color:#F97583"> as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"return_int_array(): Ran into error, freeing memory. Error: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">e</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_int_array_result(c_array)  </span><span style="color:#6A737D"># In case you define a similar freeing function for input</span></span>
<span class="line"><span style="color:#F97583">        raise</span><span style="color:#E1E4E8"> e</span></span>
<span class="line"><span style="color:#F97583">    finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_int_array_result(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> return_float_array</span><span style="color:#E1E4E8">(c_array: CFloatArray, number_of_elements: </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">) -> list[</span><span style="color:#79B8FF">float</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#9ECBFF">    """Debugging function that shows you the Go representation of a C float array and returns a Python list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - DOES NOT FREE INPUT ARRAY ON SUCCESS</span></span>
<span class="line"><span style="color:#9ECBFF">    - Frees input array ONLY on exception</span></span>
<span class="line"><span style="color:#9ECBFF">    - Returns the PYTHON list version, do not reassign input variable</span></span>
<span class="line"><span style="color:#9ECBFF">    - The data is only accurate up to ~4 decimals (i.e. if value is -790.5207366698761 you might get -790.520751953125)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Returns</span></span>
<span class="line"><span style="color:#9ECBFF">    -------</span></span>
<span class="line"><span style="color:#9ECBFF">    list[float]</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.return_float_array(c_array, number_of_elements)</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        result_data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [result_data.data[i] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(result_data.numberOfElements)]</span></span>
<span class="line"><span style="color:#F97583">    except</span><span style="color:#79B8FF"> Exception</span><span style="color:#F97583"> as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"return_float_array(): Ran into error, freeing memory. Error: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">e</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_float_array_result(c_array)  </span><span style="color:#6A737D"># In case you define a similar freeing function for input</span></span>
<span class="line"><span style="color:#F97583">        raise</span><span style="color:#E1E4E8"> e</span></span>
<span class="line"><span style="color:#F97583">    finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_float_array_result(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> print_string</span><span style="color:#E1E4E8">(text: </span><span style="color:#79B8FF">str</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> bytes</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Prints a string's go representation, useful to look for encoding issues</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    text : str | bytes</span></span>
<span class="line"><span style="color:#9ECBFF">        The data you want to see the go representation of</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    c_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> prepare_string(text)</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.print_string(c_input)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> print_string_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">str</span><span style="color:#F97583">|</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">]):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Prints a string array's go representation, useful to look for encoding issues</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does not free because everything is allocated in python, so GC will take care of it</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[str | bytes]</span></span>
<span class="line"><span style="color:#9ECBFF">        The data you want to see the go representation of</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array, number_of_items </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> prepare_string_array(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    lib.print_string_array(c_array, number_of_items)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> print_int_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">]):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Prints a int array's go representation, useful to look for rounding/conversion issues</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does not free because everything is allocated in python, so GC will take care of it</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[int]</span></span>
<span class="line"><span style="color:#9ECBFF">        The data you want to see the go representation of</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array, number_of_items </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> prepare_int_array(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    lib.print_int_array(c_array, number_of_items)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> print_float_array</span><span style="color:#E1E4E8">(data:list[</span><span style="color:#79B8FF">float</span><span style="color:#E1E4E8">]):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Prints a float array's go representation, useful to look for rounding/conversion issues</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Notes</span></span>
<span class="line"><span style="color:#9ECBFF">    -----</span></span>
<span class="line"><span style="color:#9ECBFF">    - Does not free because everything is allocated in python, so GC will take care of it</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    Parameters</span></span>
<span class="line"><span style="color:#9ECBFF">    ----------</span></span>
<span class="line"><span style="color:#9ECBFF">    data : list[float]</span></span>
<span class="line"><span style="color:#9ECBFF">        The data you want to see the go representation of</span></span>
<span class="line"><span style="color:#9ECBFF">    """</span></span>
<span class="line"><span style="color:#E1E4E8">    c_array, number_of_items </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> prepare_float_array(data)</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.print_float_array(c_array, number_of_items)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ========== Free Functions ==========</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_c_string</span><span style="color:#E1E4E8">(ptr: c_char_p):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees a single C string returned from Go (allocated via C.CString)."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.FreeCString(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_string_array</span><span style="color:#E1E4E8">(ptr: CStringArray, count: </span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees an array of C strings returned from Go."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.FreeStringArray(ptr, count)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_int_array</span><span style="color:#E1E4E8">(ptr: CIntArray):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees a C int array returned from Go."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.FreeIntArray(ptr)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_float_array</span><span style="color:#E1E4E8">(ptr: CFloatArray):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees a C float array returned from Go."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.FreeFloatArray(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_string_array_result</span><span style="color:#E1E4E8">(ptr: _CStringArrayResult):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees a StringArrayResult (including the array of strings and struct itself)."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string_array_result(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_int_array_result</span><span style="color:#E1E4E8">(ptr: _CIntArrayResult):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees an IntArrayResult (including the array and the struct itself)."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_int_array_result(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> free_float_array_result</span><span style="color:#E1E4E8">(ptr: _CFloatArrayResult):</span></span>
<span class="line"><span style="color:#9ECBFF">    """Frees a FloatArrayResult (including the array and the struct itself)."""</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_float_array_result(ptr)</span></span>
<span class="line"></span></code></pre>
<p><code>__init__.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#9ECBFF">"""A package to help with building Go-python libraries</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Helper Functions</span></span>
<span class="line"><span style="color:#9ECBFF">----------------</span></span>
<span class="line"><span style="color:#9ECBFF">- get_library(dll_path:str,source_path:str="", compile:bool=False) -> CDLL: Get's the DLL specified, will compile if not found and flag is specified</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Converting to ctypes</span></span>
<span class="line"><span style="color:#9ECBFF">--------------------</span></span>
<span class="line"><span style="color:#9ECBFF">- prepare_string(data: str | bytes) -> c_char_p: Takes in a string and returns a C-compatible string</span></span>
<span class="line"><span style="color:#9ECBFF">- prepare_string_array(data:list[str|bytes]) -> tuple[Array[c_char_p], int]: Takes in a string list, and converts it to a C-compatible array</span></span>
<span class="line"><span style="color:#9ECBFF">- prepare_int_array(data:list[int]) -> tuple[Array[c_int], int]: Takes in a int list, and converts it to a C-compatible array</span></span>
<span class="line"><span style="color:#9ECBFF">- prepare_float_array(data:list[float]) -> tuple[Array[c_float], int]: Takes in a float list, and converts it to a C-compatible array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Converting from ctypes</span></span>
<span class="line"><span style="color:#9ECBFF">----------------------</span></span>
<span class="line"><span style="color:#9ECBFF">- string_to_str(pointer: c_char_p) -> str: Takes in a pointer to a C string and returns a Python string</span></span>
<span class="line"><span style="color:#9ECBFF">- string_array_result_to_list(pointer:_CStringArrayResult) -> list[str]: </span></span>
<span class="line"><span style="color:#9ECBFF">- int_array_result_to_list(pointer: _CIntArrayResult) -> list[int]: </span></span>
<span class="line"><span style="color:#9ECBFF">- float_array_result_to_list(pointer: _CFloatArrayResult) -> list[float]: </span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Debugging Functions</span></span>
<span class="line"><span style="color:#9ECBFF">-------------------</span></span>
<span class="line"><span style="color:#9ECBFF">- return_string(text: str | bytes) -> str: Debugging function that shows you the Go representation of a C string and returns the python string version</span></span>
<span class="line"><span style="color:#9ECBFF">- return_string_array(c_array:CStringArray, number_of_elements:int) ->list[str]: Debugging function that shows you the Go representation of a C array and returns the python list version (does not free)</span></span>
<span class="line"><span style="color:#9ECBFF">- return_int_array(c_array: CIntArray, number_of_elements: int) -> list[int]: Debugging function that shows you the Go representation of a C int array and returns a Python list</span></span>
<span class="line"><span style="color:#9ECBFF">- return_float_array(c_array: CFloatArray, number_of_elements: int) -> list[float]: Debugging function that shows you the Go representation of a C float array and returns a Python list</span></span>
<span class="line"><span style="color:#9ECBFF">- print_string(text: str | bytes): Prints a string's go representation, useful to look for encoding issues</span></span>
<span class="line"><span style="color:#9ECBFF">- print_string_array(data:list[str|bytes]): Prints a string array's go representation, useful to look for encoding issues</span></span>
<span class="line"><span style="color:#9ECBFF">- print_int_array(data:list[int]): Prints a int array's go representation, useful to look for rounding/conversion issues</span></span>
<span class="line"><span style="color:#9ECBFF">- print_float_array(data:list[float]): Prints a float array's go representation, useful to look for rounding/conversion issues</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Freeing Functions</span></span>
<span class="line"><span style="color:#9ECBFF">-----------------</span></span>
<span class="line"><span style="color:#9ECBFF">- free_c_string(ptr: c_char_p): Frees a single C string returned from Go (allocated via C.CString).</span></span>
<span class="line"><span style="color:#9ECBFF">- free_string_array(ptr: CStringArray, count: int): Frees an array of C strings returned from Go.</span></span>
<span class="line"><span style="color:#9ECBFF">- free_int_array(ptr: CIntArray): Frees a C int array returned from Go.</span></span>
<span class="line"><span style="color:#9ECBFF">- free_float_array(ptr: CFloatArray): Frees a C float array returned from Go.</span></span>
<span class="line"><span style="color:#9ECBFF">- free_string_array_result(ptr: _CStringArrayResult): Frees a StringArrayResult (including the array of strings and struct itself).</span></span>
<span class="line"><span style="color:#9ECBFF">- free_int_array_result(ptr: _CIntArrayResult): Frees an IntArrayResult (including the array and the struct itself).</span></span>
<span class="line"><span style="color:#9ECBFF">- free_float_array_result(ptr: _CFloatArrayResult): Frees a FloatArrayResult (including the array and the struct itself).</span></span>
<span class="line"><span style="color:#9ECBFF">"""</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> os</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Exported functions</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> .lib </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">    get_library,</span></span>
<span class="line"><span style="color:#E1E4E8">    prepare_string,</span></span>
<span class="line"><span style="color:#E1E4E8">    prepare_string_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    prepare_int_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    prepare_float_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    string_array_result_to_list,</span></span>
<span class="line"><span style="color:#E1E4E8">    int_array_result_to_list,</span></span>
<span class="line"><span style="color:#E1E4E8">    float_array_result_to_list,</span></span>
<span class="line"><span style="color:#E1E4E8">    return_string,</span></span>
<span class="line"><span style="color:#E1E4E8">    return_string_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    return_int_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    return_float_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    print_string,</span></span>
<span class="line"><span style="color:#E1E4E8">    print_string_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    print_int_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    print_float_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_c_string,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_string_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_int_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_float_array,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_string_array_result,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_int_array_result,</span></span>
<span class="line"><span style="color:#E1E4E8">    free_float_array_result,</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Check if library exists, and if it doesn't compile it</span></span>
<span class="line"><span style="color:#E1E4E8">dll_source_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)), </span><span style="color:#9ECBFF">"lib.go"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    dll_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)),</span><span style="color:#9ECBFF">"lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    get_library(dll_file, dll_source_file, </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    dll_file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> os.path.join(os.path.dirname(os.path.realpath(</span><span style="color:#79B8FF">__file__</span><span style="color:#E1E4E8">)),</span><span style="color:#9ECBFF">"lib.so"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    get_library(dll_file, dll_source_file, </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">)</span></span></code></pre>
</details>
<p>There were some interesting lessons I learned on the way.</p>
<h3 id="array-functions">Array functions</h3>
<p>Arrays, and in particular string arrays are odd sometimes. Essentially you build a large buffer, fill it with data, and go from there. In general you‚Äôre just hoping the data doesn‚Äôt overflow. For example these lines in <code>CStringArrayToSlice()</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cStringArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfStrings</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // Setup buffer for array contents</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#E1E4E8"> bufferSize </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#6A737D"> // Allocate a huge buffer</span></span>
<span class="line"><span style="color:#E1E4E8">	stringPointers </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[bufferSize]</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(cStringArray)[:numberOfStrings:numberOfStrings]</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // other code</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Is weird, it doesn‚Äôt actualy allocate memory, but it sets up a buffer for the pointers to the strings with size of 1,073,741,824 entries (not bytes). In practical terms so long as <code>numberOfStrings &#x3C;= 1 &#x3C;&#x3C; 30</code> we‚Äôre good. For a sense of scale that number of <strong>pointers</strong> (not data) is 8GB, and if each string was 100 bytes long that would be <code>100GB</code> of RAM to just hold the strings. Here‚Äôs a chart to help understand that scale:</p>



































<table><thead><tr><th>Strings (count)</th><th>String Size</th><th>Safe Total RAM Use</th><th>Safe to Try?</th></tr></thead><tbody><tr><td>1 million</td><td>~50 bytes</td><td>~50‚Äì100 MB</td><td>Yes</td></tr><tr><td>10 million</td><td>~100 bytes</td><td>~1‚Äì2 GB</td><td>Probably</td></tr><tr><td>100 million</td><td>~100 bytes</td><td>~10+ GB</td><td>Unlikely, but possible</td></tr><tr><td>1 billion</td><td>any size</td><td>8 GB+ for pointers only</td><td>Not gonna happen</td></tr></tbody></table>
<p>Out of curiosity I tried 100 million strings on my machine (32GB of RAM) with the below test:</p>
<div class="danger-banner">
<p>The below code will kill <strong>most</strong> machines, I wouldn‚Äôt go over 10 million strings on most devices</p>
</div>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">print_string_array([random.choice([</span><span style="color:#9ECBFF">"Lorem"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ipsum"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"dolor"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"sit"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"amet"</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> _ </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> tqdm(</span><span style="color:#79B8FF">range</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100_000_000</span><span style="color:#E1E4E8">))])</span></span></code></pre>
<p>A typical page has 500 words, so roughly 200,000 pages, most books have ~200-400 pages, so this test was roughly 500-1,000 books worth of strings. Which consumed around ~16GB of ram (remember the theoretical usage is just the go side, python also has to store the data and pointers in it‚Äôs own runtime). It took ~15 mins to run and locked up my machine the whole time. All this is to say, I think the library has fair default behaviour for <strong>most</strong> use cases if you decide to use it.</p>
<h3 id="c-types">C Types</h3>
<p>As you may have noticed above the function I mentioned with string arrays had the signature of:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cStringArray</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfStrings</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {}</span></span></code></pre>
<p>Not:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CStringArrayToSlice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cStringArray</span><span style="color:#F97583"> **</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">numberOfStrings</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {}</span></span></code></pre>
<p>The <code>cStringArray</code> had to be modified to accept an <code>unsafe.Pointer</code> not a <code>**C.char</code>, why? If you try testing in the library there‚Äôs no issues, but when you‚Äôre using it as a package‚Ä¶</p>
<p>Well, if you try to use it with <code>**C.char</code> you will get an error like:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>cannot use cStringArray (variable of type **_Ctype_char) as **helper._Ctype_char value in argument to helper.CStringArrayToSlicecompilerIncompatibleAssign</span></span></code></pre>
<p>This cryptic error is because <strong>each package</strong> that uses an <code>import "C"</code> creates a <strong>separate</strong> type. So, instead of using <code>**C.char</code> the actual type is something like <code>**helper.C.char</code> (though it‚Äôs not actually even this either). I assume this is done because C is weird about namespacing, but essentially <strong>every</strong> time you <code>import "C"</code>, it creates <strong>new</strong> types. To avoid this problem we have to take the pointer as a generic pointer (essentially a <code>void*</code>), then cast it in the function to a string array.</p>
<h3 id="pinning">Pinning</h3>
<p>One of the hard-learned lessons was about memory pinning. I originally had a function like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> StringSliceToCArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Other code removed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringResult</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		numberOfElements: C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(count),</span></span>
<span class="line"><span style="color:#E1E4E8">		data:             stringArray,</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This looks innocuous enough, I‚Äôm returning a <code>StringResult</code> (a wrapper for C-string arrays that includes the length), so everything should be fine, right? No, this memory wasn‚Äôt created using <code>C.malloc</code>, it‚Äôs a C object, but the memory is <strong>owned by go</strong>. So, you get an error like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>panic: runtime error: cgo result is unpinned Go pointer or points to unpinned Go pointer</span></span></code></pre>
<p>The original Go code is returning a Go pointer to Python (via cgo), but the pointer wasn‚Äôt allocated in a way that‚Äôs safe to pass across the language boundary. Specifically, Go‚Äôs garbage collector isn‚Äôt aware that the memory is being accessed from Python, and since it‚Äôs not <a href="https://www.ibm.com/docs/ro/aix/7.2.0?topic=management-support-pinned-memory#:~:text=Pinning%20a%20memory,while%20being%20accessed.">‚Äúpinned‚Äù</a>, it can move or collect the memory. You can get around this in a fancy way using the <a href="https://go.dev/src/runtime/pinner.go"><code>runtime/pinner</code></a> module, but <a href="https://stackoverflow.com/questions/12098435/can-you-pin-an-object-in-memory-with-go">it‚Äôs complicated</a> (<a href="https://github.com/golang/go/issues/62380">quite complicated</a>). Instead if it‚Äôs being passed to <strong>outside go</strong> you <strong>always</strong> need to malloc, fill the data, then return:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> StringSliceToCArray</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputData</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Other code removed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Allocate memory for the struct</span></span>
<span class="line"><span style="color:#E1E4E8">  result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">C.StringResult)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">StringResult</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"><span style="color:#E1E4E8">  result.numberOfElements </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">  result.data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> stringArray </span><span style="color:#6A737D">// String array is a **C.char of the data from the inputData variable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The way I remember this is that when you‚Äôre exporting functions you‚Äôre dealing with C code pretending to be Go. So, no fancy Go functionality like nice syntax for structs is allowed when it‚Äôs going to cross the barrier.</p>
<h2 id="site-scraper">Site Scraper</h2>
<p>This example was the one I originally had in mind when I wanted to first try this out. Web scraping in python is a dream for data science because of it‚Äôs flexibility, but data acquisition can be slow, tedious and typically <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel#:~:text=In%20parallel%20computing%2C%20an%20embarrassingly,a%20number%20of%20parallel%20tasks.">embarassingly parallel</a>. So, the idea was to create something like this:</p>
<p><img src="/tech/blog/python-plus-go/scraper-diagram.excalidraw.png" alt=""></p>
<p>Since the first article I basically re-implemented this whole demo. I simplified the code massively from the channel-based version I initially used, and that resolved an odd memory-leak I had, which lowered the overall RAM usage. However, this was by far the most annoying code to implement <strong>on the go side</strong> due to how many things could go wrong during processing. It was also the most frustrating to debug <strong>on the python side</strong> because the bugs I encountered were so trivial, and I was overcomplicating everything. You can find a copy of the code <a href="https://github.com/Descent098/Python-Go/tree/main/examples/scraping">here</a>.</p>
<h3 id="the-emotional-toll">The emotional toll</h3>
<p>This task was the shortest Go code I had to write, but the hardest C integration by far. I ended up having to rewrite the class a bunch of times, when using my benchmarking code I would keep getting this result:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>--Go Starting--</span></span>
<span class="line"><span>Error while processing https://www.netflix.com: Get "https://www.netflix.com": stream error: stream ID 1; CANCEL; received from peer</span></span>
<span class="line"><span>Error while processing https://www.washingtonpost.com: Get "https://www.washingtonpost.com": stream error: stream ID 1; INTERNAL_ERROR; received from peer</span></span>
<span class="line"><span>Error while processing https://www.bestbuy.com: Get "https://www.bestbuy.com": stream error: stream ID 1; INTERNAL_ERROR; received from peer</span></span>
<span class="line"><span>Error while processing https://www.adidas.com: Get "https://www.adidas.com": stream error: stream ID 1; INTERNAL_ERROR; received from peer</span></span>
<span class="line"><span>Error while processing https://www.adobe.com: Get "https://www.adobe.com": context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span></span>
<span class="line"><span>Error while processing https://www.tesla.com: Get "https://www.tesla.com": stream error: stream ID 1; INTERNAL_ERROR; received from peer</span></span>
<span class="line"><span>Error while processing https://www.flipkart.com: context deadline exceeded (Client.Timeout or context cancellation while reading body)</span></span>
<span class="line"><span>Storing site 0/99</span></span>
<span class="line"><span>Storing site 1/99</span></span>
<span class="line"><span></span></span>
<span class="line"><span>~/Python-Go/examples/scraping></span></span></code></pre>
<p>It would run the first site properly, then die. The worst part was that this happened 3/5 runs, so some runs would still complete. This took me 2 days to fix of banging my head against the wall. Can you spot the bug:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">@dataclass</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> Site</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    url:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D">         # the raw URL</span></span>
<span class="line"><span style="color:#E1E4E8">    domain:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D">      # The domain the URL is hosted at</span></span>
<span class="line"><span style="color:#E1E4E8">    server:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D">      # The value of the server header</span></span>
<span class="line"><span style="color:#E1E4E8">    protocol:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D">    # The protocl of the site (http or https)</span></span>
<span class="line"><span style="color:#E1E4E8">    contentType:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D"> # The content type of the body (i.e. "text/html")</span></span>
<span class="line"><span style="color:#E1E4E8">    body:</span><span style="color:#79B8FF">str</span><span style="color:#6A737D">        # The body of the url</span></span>
<span class="line"><span style="color:#E1E4E8">    port:</span><span style="color:#79B8FF">int</span><span style="color:#6A737D">        # The port the url is on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> from_urls</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'Site'</span><span style="color:#E1E4E8">, urls:list[</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">]) -> list[</span><span style="color:#9ECBFF">'Site'</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#E1E4E8">        count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(urls)</span></span>
<span class="line"><span style="color:#E1E4E8">        encoded </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p(url.encode(</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> url </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> urls]</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        # Create a C array of char* (aka **char)</span></span>
<span class="line"><span style="color:#E1E4E8">        array_type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> count</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#E1E4E8">        url_array </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> array_type(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">encoded)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.parse_urls(url_array, count)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> pointer:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Failed to parse URLs"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#79B8FF">            print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Storing site </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">i</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">/</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">count</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">            site_ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer[i]</span></span>
<span class="line"><span style="color:#E1E4E8">            data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> site_ptr</span></span>
<span class="line"><span style="color:#F97583">            try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">                results.append(</span><span style="color:#79B8FF">cls</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">                    url</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.url.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    domain</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.domain.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    server</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.server.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    protocol</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.protocol.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    contentType</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.contentType.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    body</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.body.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                    port</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.port</span></span>
<span class="line"><span style="color:#E1E4E8">                ))</span></span>
<span class="line"><span style="color:#F97583">            except</span><span style="color:#79B8FF"> AttributeError</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">                continue</span><span style="color:#6A737D"> # No data</span></span>
<span class="line"><span style="color:#F97583">            finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">                cls</span><span style="color:#E1E4E8">.free_sites(pointer,count )</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">staticmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> free_sites</span><span style="color:#E1E4E8">(array_pointer: _CSite, count:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> array_pointer:</span></span>
<span class="line"><span style="color:#F97583">            return</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_sites(array_pointer, count)</span></span></code></pre>
<details><summary>Click for Answer</summary>
<p>The lib.free_sites() is being called in the loop:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#79B8FF">  print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Storing site </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">i</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">/</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">count</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  site_ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer[i]</span></span>
<span class="line"><span style="color:#E1E4E8">  data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> site_ptr</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      results.append(</span><span style="color:#79B8FF">cls</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">          url</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.url.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          domain</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.domain.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          server</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.server.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          protocol</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.protocol.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          contentType</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.contentType.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          body</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.body.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">          port</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.port</span></span>
<span class="line"><span style="color:#E1E4E8">      ))</span></span>
<span class="line"><span style="color:#F97583">  except</span><span style="color:#79B8FF"> AttributeError</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">      continue</span><span style="color:#6A737D"> # No data</span></span>
<span class="line"><span style="color:#F97583">  finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">      cls</span><span style="color:#E1E4E8">.free_sites(pointer,count )</span></span></code></pre>
<p>here is the fixed code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#79B8FF">      print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Storing site </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">i</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">/</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">count</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      site_ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer[i]</span></span>
<span class="line"><span style="color:#E1E4E8">      data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> site_ptr</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">          results.append(</span><span style="color:#79B8FF">cls</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">              url</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.url.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              domain</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.domain.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              server</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.server.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              protocol</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.protocol.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              contentType</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.contentType.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              body</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.body.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">              port</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.port</span></span>
<span class="line"><span style="color:#E1E4E8">          ))</span></span>
<span class="line"><span style="color:#F97583">      except</span><span style="color:#79B8FF"> AttributeError</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">          continue</span><span style="color:#6A737D"> # No data for one of the values</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">  cls</span><span style="color:#E1E4E8">.free_sites(pointer,count )</span></span></code></pre>
</details>
<p>I gaslit myself for 2 days that it had to be an issue in my CGo code, when actually it was a python mistake. I‚Äôm not entirely sure why the code would succeed occasionally, that part still stumps me to this day. My assumption is I was being rate limited so my requests weren‚Äôt even starting and were all returning empty data .</p>
<h2 id="spell-check">Spell Check</h2>
<p>A few years ago I needed (wanted) to implement a spell checker for a work project. It was a cli with about a dozen options for commands, as well as the ability to select from one of a few dozen environments we had. For both I wanted spell check to help catch people when things went wrong. So for example lets say you have 4 valid options, I would want code like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">valid_options </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">"init"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"move"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"delete"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ingest"</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">valid_input </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">while</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> valid_input:</span></span>
<span class="line"><span style="color:#E1E4E8">    response </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> input</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Enter your action: "</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> valid_options:</span></span>
<span class="line"><span style="color:#E1E4E8">        suggest_word(response, valid_options)</span></span>
<span class="line"><span style="color:#F97583">    else</span><span style="color:#E1E4E8">: </span><span style="color:#6A737D"># Validated</span></span>
<span class="line"><span style="color:#E1E4E8">        valid_input </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> True</span></span>
<span class="line"><span style="color:#E1E4E8">        do_action(response)</span></span></code></pre>
<p>So if you typed in something like <code>inyt</code> you would get a message saying <code>invalid command, were you trying to use init?</code>. Same thing with the environments if you misspelt one, it would suggest the closest valid one. With python I did this originally with <a href="https://github.com/rapidfuzz/Levenshtein">Levenstein</a>, but I wanted to use this as a test since the calculations can be quite computationally expensive. I wanted to keep the code simple, so I also didn‚Äôt want to use multithreading, or anything fancy. Basically just a straight drag race of python alone vs python + go.</p>
<p>I ended up with <a href="https://github.com/Descent098/Python-Go/tree/main/examples/similarity">two versions</a>:</p>
<ol>
<li>The originals; These two versions use a pre-determined dictionary of ~370,000 words. Handy for more traditional spellcheck</li>
<li>With Helpers; This version instead lets you input your own dictionary of words to search through, more practical, but in most cases harder to see as much improvment (most people don‚Äôt include a ton of words)</li>
</ol>
<p>In both cases go performed admirably, and in general if I were to optimize the code with multithreading it would be a night and day difference. Here is what the setup looked like:</p>
<p><img src="/tech/blog/python-plus-go/similarity-diagram.excalidraw.png" alt=""></p>
<h3 id="windows-dangers">Windows Dangers</h3>
<p>I learned a lot making spell check, but the most prominent lesson I learned was with the issues of building on windows. I Have been a long-time supporter of making code cross platform, and I personally use windows a lot, but there were many times I was being driven over the edge by how annoying it made this whole process.</p>
<p>To give the devil his due Microsoft is at a bit of a catch-22. There‚Äôs constantly malware being written, and I understand trying to keep people safe, however, compiling can be a nightmare on windows. My original approach was a bit too clever for my own good.</p>
<div class="warning-banner">
<p>For windows users we <a href="https://github.com/Descent098/Python-Go/tree/main/examples/similarity/original-embedded">this version</a> uses <code>//embed</code> is a common method for hackers to use to embed dangerous payloads, so windows won‚Äôt let us compile until we modify settings. If you want to run it, here‚Äôs the steps:</p>
<details><summary>Click for instructions</summary>
<ol>
<li>Create a folder that we can use as a temporary folder. For me I add it to my downloads folder under <code>/go-temp</code></li>
<li>From there we need to reset our <code>GOTEMPDIR</code> to the folder we created for me that‚Äôs <code>%USERPROFILE%\Downloads\go-temp</code> so I would run <code>go env -w GOTMPDIR="%USERPROFILE%\Downloads\go-temp</code></li>
<li>Set up an exclusion in the windows defender using the steps below</li>
</ol>
<p><img src="/tech/blog/python-plus-go/setup-exclusions.png" alt=""></p>
</details>
</div>
<p>That being said, <a href="https://github.com/Descent098/Python-Go/tree/main/examples/similarity/original-hardcoded">the second version</a> of the same code fixes this in an idiotic way. I just inlined the text file directly. I don‚Äôt know why microsoft doesn‚Äôt consider a ~370,000 item list to be suspicious, but somehow they don‚Äôt.</p>
<h2 id="practical-tips">Practical tips</h2>
<p>Here are a few other takeaways:</p>
<ul>
<li>
<p>Problems can come from either side of the fence</p>
<ul>
<li>Some bugs will be in your go logic, some in your python logic, some in the binding layers between them. The reason I wrote the helper was to help avoid at least the last two possibilities (to some success)</li>
<li>When compiling your go code, <a href="https://pkg.go.dev/runtime?utm_source=godoc#hdr-Environment_Variables">GOTRACEBACK</a> can be a godsend. The default ‚Äúproduction‚Äù tracebacks are a nightmare to debug with. You can find information about this variable below
<ul>
<li><a href="https://dave.cheney.net/tag/gotraceback">https://dave.cheney.net/tag/gotraceback</a></li>
<li><a href="https://gist.github.com/pohzipohzi/eb9735099a3b6b8c808877449febd5e8">https://gist.github.com/pohzipohzi/eb9735099a3b6b8c808877449febd5e8</a></li>
</ul>
</li>
<li>When debugging your python code, the <a href="https://docs.python.org/3/library/gc.html"><code>gc</code></a> module is a trap. The documentation will tell you that if you want to try to debug leaks you can checkout <code>gc.set_debug(gc.DEBUG_LEAK)</code>. The leaks referred to here are <strong>python</strong> related, not <code>ctype</code> related. This is useful to check if you‚Äôre accidentally holding a reference to a python object, but not if your go-allocated objects are hanging around.</li>
<li><a href="https://docs.python.org/3/library/tracemalloc.html"><code>tracemalloc</code></a> is also another python trap, it can only see memory allocated by python, none in the C runtime</li>
</ul>
</li>
<li>
<p>Keep your code simple</p>
<ul>
<li>Working with these two discrete but linked systems is complicated enough, don‚Äôt add the complexity of overly clever code on top of that</li>
<li>Originally I built everything with channels because I wanted to learn about them. I endded up dropping channels (except for my semaphore) and went with <a href="https://victoriametrics.com/blog/go-sync-map/">sync.Map</a> + <a href="https://victoriametrics.com/blog/go-sync-waitgroup/index.html">sync.WaitGroup</a>, then I failed at that somehow and instead went with a standard array and a <a href="https://go.dev/tour/concurrency/9">sync.Mutex</a>. This resulted in less than 1ms time difference, but much, much simpler to understand
<ul>
<li>Hacks are hacky, but somteimes work well
<ul>
<li>Quick and dirty <a href="https://medium.com/@deckarep/gos-extended-concurrency-semaphores-part-1-5eeabfa351ce">Semaphore</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Testing is incredibly hard to do well</p>
<ul>
<li>There are many instances that either language will try to stop you from doing before you do them. So invalid states are hard to emulate sometimes</li>
<li>In Go you CANNOT use the <code>C</code> package, which means your API has to be fully exposed with any functions you need for testing</li>
</ul>
</li>
<li>
<p>Go packaging is hard to get right, not an issue specific to any of this code, but just be aware of that</p>
</li>
<li>
<p>It took me a few days to solve an issue in go related to how the concurrency was being managed in the scraper.</p>
<ul>
<li>Normally this would be trivial to debug with the <code>-race</code> flag, however windows further complicated development (been happening a lot recently), and I actually ended up having to switch to linux to debug what was happening because although <code>zig cc</code> is a wonderful crossplatform miracle, it doesn‚Äôt run <a href="https://go.dev/doc/articles/race_detector">go‚Äôs race detector</a> properly.</li>
</ul>
</li>
<li>
<p>In general this solution is relatively fragile</p>
<ul>
<li>I did not try this on multiple distributions, I suspect building these packages for various distributions would be time-consuming, and suck</li>
<li>I tested on a single <a href="https://gist.github.com/asukakenji/f15ba7e588ac42795f421b48b8aede63">GOOS and GOARCH</a>
<ul>
<li>Different GOOS and GOARCH would need to be built separately, which makes this a pain in the ass on the go and python side (to import)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="conclusions">Conclusions</h2>
<p>I am glad I explored using CGO for accelerating python, that being said it was incredibly annoying. If you do not need it, I would not recommend it. There are many options for subtle bugs that are hard to avoid. Even in these relatively trivial examples it was a lot of code, with a good amount of surface area to break things. If you do need it, I hope the tooling I wrote is helpful. I would say give it a shot, I learned a lot, but for production I don‚Äôt want to ‚Äúlearn‚Äù I want things that ‚Äúwork‚Äù, and this takes a lot of fiddling to get right.</p>  </article> </main> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js" integrity="sha256-mm3Re3y7xlvh+yCD+l/Zs1d+PU0AEad93MkWvljfm/s=" crossorigin="anonymous"></script>   </main> </div> <footer class="footer footer-center block mb-5 pt-10"> <div class="pb-2">
&copy; 2025 Kieran Wood
</div> <div class="inline opacity-75"> <!-- Thanks for using this template. You can keep this line to support my work :) --> <a href="https://astrofy-template.netlify.app/" target="_blank" class="font-bold">Astrofy Template</a> developed by
<a href="https://manuelernestog.github.io" target="_blank" class="font-bold">Manuel Ernesto ‚ö°Ô∏è</a> </div> </footer>  </div> <div class="drawer-side z-40"> <label for="my-drawer" class="drawer-overlay"></label> <aside class="px-2 pt-2 h-auto min-h-full w-[19rem] bg-base-200 text-base-content flex flex-col"> <div class="w-fit mx-auto mt-5 mb-6"> <a href="/"> <div class="avatar transition ease-in-out hover:scale-[102%] block m-auto"> <div class="w-[8.5rem]"> <img src="/tech/profile.jpg" class="mask mask-circle" alt="Profile image" width="300" height="300" loading="lazy" decoding="async"> </div> </div> </a> </div> <ul class="menu grow shrink menu-md overflow-y-auto"> <li><a class="py-3 text-base" id="home" href="/tech/">Home</a></li> <li><a class="py-3 text-base" id="projects" href="/tech/projects">Projects</a></li> <!-- <li><a class="py-3 text-base" id="services" href="/tech/services">Services</a></li>
    <li><a class="py-3 text-base" id="store" href="/tech/store">Store</a></li> --> <li><a class="py-3 text-base" id="blog" href="/tech/blog/">Blog</a></li> <li><a class="py-3 text-base" id="cv" href="/tech/cv">CV</a></li> <li><a class="py-3 text-base" href="/tech/contact">Contact</a></li> </ul> <script>(function(){const sideBarActiveItemID = undefined;
const activeClass = "bg-base-300";

const activeItemElem = document.getElementById(sideBarActiveItemID);
activeItemElem && activeItemElem.classList.add(activeClass);
})();</script> <div class="block sticky pointer-events-none bottom-10 bg-base-200 justify-center h-12 [mask-image:linear-gradient(transparent,#000000)]"></div> <div class="social-icons px-4 pb-5 pt-1 flex self-center justify-center sticky bottom-0 bg-base-200"> <a href="https://github.com/descent098" target="_blank" class="mx-3" aria-label="Github" title="Github"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"></path> </svg> </a> <a href="https://www.linkedin.com/in/kieran-wood" target="_blank" class="mx-3" aria-label="Linkedin" title="Linkedin"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><circle cx="4.983" cy="5.009" r="2.188"></circle><path d="M9.237 8.855v12.139h3.769v-6.003c0-1.584.298-3.118 2.262-3.118 1.937 0 1.961 1.811 1.961 3.218v5.904H21v-6.657c0-3.27-.704-5.783-4.526-5.783-1.835 0-3.065 1.007-3.568 1.96h-.051v-1.66H9.237zm-6.142 0H6.87v12.139H3.095z"></path> </svg> </a> <a href="https://instagram.com/descent098" target="_blank" class="mx-3" aria-label="Instagram" title="Instagram"> <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 -5 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"></path> </svg> </a> <a href="/rss.xml" target="_blank" class="mx-3" aria-label="RSS Feed" title="RSS Feed"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19 20.001C19 11.729 12.271 5 4 5v2c7.168 0 13 5.832 13 13.001h2z"></path><path d="M12 20.001h2C14 14.486 9.514 10 4 10v2c4.411 0 8 3.589 8 8.001z"></path><circle cx="6" cy="18" r="2"></circle> </svg> </a> </div> </aside> </div> </div> </body></html>