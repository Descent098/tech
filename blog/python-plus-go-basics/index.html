<!DOCTYPE html><html lang="en" data-theme="lofi"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/jpeg" href="/tech/profile.jpg"><meta name="generator" content="Astro v5.15.8"><!-- Primary Meta Tags --><title>Python + Go: The basics | Kieran Wood</title><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/tech/_astro/ClientRouter.astro_astro_type_script_index_0_lang.QW52Ox2j.js"></script><meta name="title" content="Python + Go: The basics"><meta name="description" content="How to start using CGo and CTypes to connect python and go"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://kieranwood.ca/tech/blog/python-plus-go-basics/"><meta property="og:title" content="Python + Go: The basics"><meta property="og:description" content="How to start using CGo and CTypes to connect python and go"><meta property="og:image" content="https://kieranwood.ca/tech/blog/python-plus-go/diagram.excalidraw.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://kieranwood.ca/tech/blog/python-plus-go-basics/"><meta property="twitter:title" content="Python + Go: The basics"><meta property="twitter:description" content="How to start using CGo and CTypes to connect python and go"><meta property="twitter:image" content="https://kieranwood.ca/tech/blog/python-plus-go/diagram.excalidraw.png"><link rel="stylesheet" href="/tech/_astro/_page_.7orOsfmi.css">
<style>.time-line-container>div:last-child .education__time>.education__line{display:none}details{background:#f0f0f0;padding:1rem;border-radius:.7rem;margin:.5rem auto;width:100%}summary{cursor:pointer}#TOC-list{list-style:none}#TOC-list li{margin-top:.15rem}.danger-banner{display:flex;flex-direction:row;background:#f44336;border-radius:.25rem;padding:1.1rem;color:#fff!important;flex-wrap:wrap}.danger-banner strong,.danger-banner a{color:#fff!important}.danger-banner:before{content:"!üõë Danger üõë!";flex-basis:100%;margin-bottom:.5rem;padding:.6rem;border-radius:.25rem;text-align:center;background:red;text-transform:uppercase}.warning-banner{display:flex;flex-direction:row;background:#fcc51e;border-radius:.25rem;padding:1.1rem;color:#141414!important;flex-wrap:wrap}.warning-banner strong,.warning-banner a{color:#141414!important}.warning-banner:before{content:"üü° Warning üü°";flex-basis:100%;margin-bottom:.5rem;padding:.6rem;border-radius:.25rem;text-align:center;background:#f6cb49;text-transform:uppercase;text-shadow:1px 1px 1px rgb(93,93,93)}.level-3{text-indent:1rem}.level-4{text-indent:2rem}.level-5{text-indent:3rem}.level-6{text-indent:4rem}.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0;mix-blend-mode:plus-lighter}to{opacity:1;mix-blend-mode:plus-lighter}}@keyframes astroFadeOut{0%{opacity:1;mix-blend-mode:plus-lighter}to{opacity:0;mix-blend-mode:plus-lighter}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media(prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
</style><style>[data-astro-transition-scope="astro-vz7ejtmd-1"] { view-transition-name: __2ftech_2fblog_2fpython-plus-go_2fdiagram_2eexcalidraw_2epng; }</style><style>[data-astro-transition-scope="astro-frvnq75b-2"] { view-transition-name: Python_20_2b_20Go_3a_20The_20basics; }</style></head> <body> <div class="bg-base-100 drawer lg:drawer-open"> <input id="my-drawer" type="checkbox" class="drawer-toggle"> <div class="drawer-content bg-base-100"> <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm"> <div class="navbar"> <div class="navbar-start"> <label for="my-drawer" class="btn btn-square btn-ghost"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path> </svg> </label> </div> <div class="navbar-center"> <a class="btn btn-ghost normal-case text-xl" href="/">Kieran Wood ‚ö°Ô∏è</a> </div> <div class="navbar-end"></div> </div> </div> <div class="md:flex md:justify-center"> <main class="p-6 pt-10 lg:max-w-[900px] max-w-[100vw]">  <main class="md:flex md:justify-center"> <article class="prose prose-lg max-w-[750px] prose-img:mx-auto"> <img src="/tech/blog/python-plus-go/diagram.excalidraw.png" alt="Python + Go: The basics" style="border-radius:.5em" data-astro-transition-scope="astro-vz7ejtmd-1" loading="lazy" decoding="async" fetchpriority="auto" width="750" height="422" class="w-full mb-6"> <h1 class="title my-2 text-4xl font-bold" data-astro-transition-scope="astro-frvnq75b-2">Python + Go: The basics</h1> <time>May 6, 2025</time> <br>  <a href="/blog/tag/python" class="badge badge-outline ml-2 no-underline"> python </a><a href="/blog/tag/go" class="badge badge-outline ml-2 no-underline"> go </a><a href="/blog/tag/C" class="badge badge-outline ml-2 no-underline"> C </a><a href="/blog/tag/web" class="badge badge-outline ml-2 no-underline"> web </a><a href="/blog/tag/theory" class="badge badge-outline ml-2 no-underline"> theory </a><a href="/blog/tag/packages" class="badge badge-outline ml-2 no-underline"> packages </a>   <div class="divider my-2"></div> <div> <h2>Table of contents</h2> <ul id="TOC-list"> <li class="level-2"> <a href="#easy-parts" class="no-underline"> Easy parts </a> </li><li class="level-3"> <a href="#go" class="no-underline"> Go </a> </li><li class="level-4"> <a href="#prepping-cgo" class="no-underline"> Prepping cgo </a> </li><li class="level-4"> <a href="#converting-functions" class="no-underline"> Converting Functions </a> </li><li class="level-3"> <a href="#python" class="no-underline"> Python </a> </li><li class="level-2"> <a href="#the-hard-part" class="no-underline"> The hard part </a> </li><li class="level-3"> <a href="#strings" class="no-underline"> Strings </a> </li><li class="level-3"> <a href="#classes--slices" class="no-underline"> Classes &amp; Slices </a> </li><li class="level-4"> <a href="#pattern-for-classes" class="no-underline"> Pattern for classes </a> </li><li class="level-4"> <a href="#slices" class="no-underline"> Slices </a> </li><li class="level-4"> <a href="#all-together-now" class="no-underline"> All together now </a> </li><li class="level-2"> <a href="#conclusions" class="no-underline"> Conclusions </a> </li><li class="level-2"> <a href="#references" class="no-underline"> References </a> </li> </ul> </div>
  <hr><p>Python can be slow at the best of times, but switching to another language can waste a ton of your time rewritting. Instead, is it worth it to integrate libraries written in other languages for the slow parts of python, and use python for the rest? What are the pros and cons to doing this?</p>
<p>Before starting this article is quite a bit more complicated than my usual ones. I try to make things simple, but to fully understand it you will need to know:</p>
<ol>
<li>Python quite well</li>
<li>Enough go and C to at least be able to read, and conceptually understand the code</li>
<li>If you want to be able to work with structs/classes and strings you will also need to understand how they work in C</li>
</ol>
<p>For Go I would recommend:</p>
<ul>
<li><a href="https://go.dev/tour/list">A tour of Go (up to before Generics)</a></li>
</ul>
<p>For C:</p>
<ul>
<li><a href="https://www.w3schools.com/c/c_data_types.php">basic data types</a></li>
<li><a href="https://www.w3schools.com/c/c_strings.php">strings</a></li>
<li><a href="https://www.w3schools.com/c/c_structs.php">structs (similar to classes without methods)</a></li>
<li><a href="https://www.w3schools.com/c/c_pointers.php">pointers</a></li>
</ul>
<p>If you haven‚Äôt seen it yet, I would <strong>highly</strong> recommend reading the <a href="https://kieranwood.ca/tech/blog/python-plus-go-intro">introduction article</a> and then coming back. It‚Äôs short, and gives you handy information you need to understand this article.</p>
<h2 id="easy-parts">Easy parts</h2>
<p>So, let‚Äôs get started with the simple stuff. A function in go that prints something, and calling it from python. First let‚Äôs setup the Go code.</p>
<h3 id="go">Go</h3>
<p>To get started run <code>go mod init lib</code>, this will setup our go project in the folder. From there you can create a file called <code>lib.go</code>. As a sanity check let‚Äôs try just running our code in go:</p>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Greeting</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello from Go!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">	Greeting</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Now run <code>go run lib.go</code>, and you should get <code>Hello from Go!</code> in your terminal. Now let‚Äôs add one more function called <code>Factorial()</code> that will take in a number, and return the <a href="https://www.freecodecamp.org/news/what-is-a-factorial/">factorial</a> of it:</p>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Greeting</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello from Go!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Factorial</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n</span></span>
<span class="line"><span style="color:#E1E4E8">	lastVal </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#F97583"> range</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n) {</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> lastVal </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			result </span><span style="color:#F97583">*=</span><span style="color:#E1E4E8"> lastVal</span></span>
<span class="line"><span style="color:#E1E4E8">			lastVal </span><span style="color:#F97583">-=</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">	Greeting</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"The factorial of 10 is </span><span style="color:#79B8FF">%d\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Factorial</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Running <code>go run lib.go</code> again will result in the greeting from before and <code>The factorial of 10 is 3628800</code>. So, now we just need to prepare these functions for python.</p>
<h4 id="prepping-cgo">Prepping cgo</h4>
<p>First we will need to pull in the <a href="https://go.dev/wiki/cgo">cgo library</a>, this is done with a separate import statement, and a multiline-comment above (this will be important later):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// rest of the code here</span></span></code></pre>
<p>If you are getting errors in your editor you will need to setup a proper C compiler. For me I am going to use <code>zig cc</code>. <a href="https://ziglang.org/">Zig</a> is yet another programming language, but it‚Äôs compiler can compile C code, and it works cross platform (handy since I‚Äôm on windows and every other <code>gcc</code> didn‚Äôt work for me). If you‚Äôre on linux/MacOS and have <code>gcc</code> already, and don‚Äôt want another thing installed on your system, feel free to skip to <a href="#converting-functions">converting functions</a>.</p>
<p>To setup <code>zig cc</code> first download <a href="https://ziglang.org/download/">zig</a>, once you have it setup you should be able to run the following commands to set it as your CGo compiler:</p>
<ol>
<li>Get the binary location, on windows run <code>where zig</code> and copy the path, on linux/MacOS run <code>which zig</code></li>
<li>Run the command below replacing <code>$PathToCompiler</code> with the path you found using the command from step 1 + <code>zig cc</code>. So for me when I type <code>where zig</code> I get <code>C:\binaries\zig-windows-x86_64-0.14.0-dev.2613+0bf44c309\zig.exe</code>, so I would replace <code>$PathToCompiler</code> with <code>C:\binaries\zig-windows-x86_64-0.14.0-dev.2613+0bf44c309\zig.exe cc</code></li>
</ol>
<p>Now set <code>zig cc</code> as your compiler using (add <code>""</code> around <code>$PathToCompiler</code> to avoid issues with spaces):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> env</span><span style="color:#79B8FF"> -w</span><span style="color:#9ECBFF"> CC="</span><span style="color:#E1E4E8">$PathToCompiler</span><span style="color:#9ECBFF">"</span></span></code></pre>
<p>Run <code>go env</code>, and you‚Äôll get a long output, but now your <code>CC</code> variable should be updated:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#E1E4E8">> </span><span style="color:#9ECBFF">go</span><span style="color:#9ECBFF"> env</span></span>
<span class="line"><span style="color:#6A737D"># Other output</span></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#9ECBFF"> CC=C:</span><span style="color:#79B8FF">\b</span><span style="color:#9ECBFF">inaries</span><span style="color:#79B8FF">\z</span><span style="color:#9ECBFF">ig-windows-x86_64-0.14.0-dev.2613+0bf44c309</span><span style="color:#79B8FF">\z</span><span style="color:#9ECBFF">ig.exe</span><span style="color:#9ECBFF"> cc</span></span>
<span class="line"><span style="color:#6A737D"># other output</span></span></code></pre>
<h4 id="converting-functions">Converting Functions</h4>
<p>Now let‚Äôs talk about how to make our functions work. For <strong>non-variadic functions</strong> (functions with <strong>no arguments</strong> and <strong>no return types</strong>) this is easy, we don‚Äôt need to change anything, except adding an export tag above the function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export Greeting</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Greeting</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello from Go!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Notice there‚Äôs no space between the <code>//</code> and <code>export</code>, this is incredibly important. If you add a space <strong>this will not export</strong>. Also the name of the export <strong>must match</strong> the function name. You can‚Äôt call your function <code>MyFunction()</code> then try to export <code>my_function</code>, this wil break.</p>
<p>Now for the harder part, variadic functions (those with arguments and/or return types). Since we are compiling our code to C, we need to have values that are C compatible. My recommendation for this is to:</p>
<ol>
<li>Create a wrapper function</li>
<li>Give the wrapper function C-compatible values for arguments and/or return types</li>
<li>In the function convert the C values to go values</li>
<li>Run your Go code with those values</li>
<li>Convert the results back to C-compatible values</li>
<li>Return the C-compatible values</li>
</ol>
<p>So, let‚Äôs see how this works for our <code>Factorial()</code> function. we will need to convert our Go types to C types, here are the equivalent types:</p>

















































































































<table><thead><tr><th>go type</th><th>C type</th><th>cgo type</th><th>Python type</th></tr></thead><tbody><tr><td><code>string</code></td><td><code>char</code></td><td><code>C.char</code></td><td><code>str</code></td></tr><tr><td><code>string</code></td><td><code>signed char</code></td><td><code>C.schar</code></td><td><code>str</code></td></tr><tr><td><code>string</code></td><td><code>unsigned char</code></td><td><code>C.uchar</code></td><td><code>str</code></td></tr><tr><td><code>int16</code> or <code>int</code></td><td><code>short</code></td><td><code>C.short</code></td><td><code>int</code></td></tr><tr><td><code>uint16</code> or <code>int</code></td><td><code>unsigned short</code></td><td><code>C.ushort</code></td><td><code>int</code></td></tr><tr><td><code>int</code></td><td><code>int</code></td><td><code>C.int</code></td><td><code>int</code></td></tr><tr><td><code>uint</code></td><td><code>unsigned int</code></td><td><code>C.uint</code></td><td><code>int</code></td></tr><tr><td><code>int32</code> or <code>int</code></td><td><code>long</code></td><td><code>C.long</code></td><td><code>int</code></td></tr><tr><td><code>uint32</code> or <code>int</code></td><td><code>unsigned long</code></td><td><code>C.ulong</code></td><td><code>int</code></td></tr><tr><td><code>int64</code> or <code>int</code></td><td><code>long long</code></td><td><code>C.longlong</code></td><td><code>int</code></td></tr><tr><td><code>uint64</code> or <code>int</code></td><td><code>unsigned long long</code></td><td><code>C.ulonglong</code></td><td><code>int</code></td></tr><tr><td><code>float32</code></td><td><code>float</code></td><td><code>C.float</code></td><td><code>float</code></td></tr><tr><td><code>float64</code></td><td><code>double</code></td><td><code>C.double</code></td><td><code>float</code></td></tr><tr><td><code>struct</code></td><td><code>struct</code></td><td><code>C.struct_&#x3C;name_of_C_Struct></code></td><td><code>class</code></td></tr><tr><td><code>struct</code></td><td><code>union</code></td><td><code>C.union_&#x3C;name_of_C_Union></code></td><td><code>class</code></td></tr><tr><td><code>struct</code></td><td><code>enum</code></td><td><code>C.enum_&#x3C;name_of_C_Enum></code></td><td><code>class</code></td></tr><tr><td><code>unsafe.pointer</code></td><td><code>void*</code></td><td><code>unsafe.pointer</code></td><td>N/A</td></tr></tbody></table>
<p>*<em>Please note that unions and enums are probably better left out of your code as much as you can, they‚Äôre very finicky</em></p>
<p>Or more simply:</p>
<p><img src="/tech/blog/python-plus-go/go-cgo-conversions.excalidraw.png" alt=""></p>
<p>*<em>More about the bottom 4 in a bit</em></p>
<p>To convert from C to Go types to keep it simple I would use the functions of the table above, (i.e. <code>int()</code> to convert a <code>C.int</code>) except for:</p>
<ul>
<li><code>C.GoString()</code> (details later) for strings (<code>C.char</code>, <code>*C.char</code>, etc.)</li>
<li>Manually rebuild your structs (details later)</li>
<li>Hide from <code>unsafe.Pointer</code> unless you need it</li>
</ul>
<p>Now we can finally convert our functions. For me I like to keep my python functions <code>snake_case</code> and my Go functions <code>PascalCase</code> to make it clear which is which. In this case that means just a lowercase version of the function as a wrapper:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function to greet someone</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export Greeting</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Greeting</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello from Go!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function to calculate the factorial of a number n</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Factorial</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n</span></span>
<span class="line"><span style="color:#E1E4E8">	lastVal </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#F97583"> range</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n) {</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> lastVal </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			result </span><span style="color:#F97583">*=</span><span style="color:#E1E4E8"> lastVal</span></span>
<span class="line"><span style="color:#E1E4E8">			lastVal </span><span style="color:#F97583">-=</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// The cgo binding to call the Factorial Function through</span></span>
<span class="line"><span style="color:#6A737D">// </span></span>
<span class="line"><span style="color:#6A737D">//export factorial</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> factorial</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	goN </span><span style="color:#F97583">:=</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n)            </span><span style="color:#6A737D">// Convert to go integer</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> Factorial</span><span style="color:#E1E4E8">(goN) </span><span style="color:#6A737D">// Get go integer result</span></span>
<span class="line"><span style="color:#E1E4E8">	r </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(result)       </span><span style="color:#6A737D">// Convert to C integer</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> r</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// This has to stay here, but leave it empty</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Now we can check if this works. We can build it using:</p>
<details><summary>Linux/Mac</summary>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> build</span><span style="color:#79B8FF"> -buildmode=c-shared</span><span style="color:#79B8FF"> -o</span><span style="color:#9ECBFF"> lib.so</span><span style="color:#9ECBFF"> lib.go</span><span style="color:#E1E4E8"> </span></span></code></pre>
</details>
<details><summary>Windows</summary>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> build</span><span style="color:#79B8FF"> -buildmode=c-shared</span><span style="color:#79B8FF"> -o</span><span style="color:#9ECBFF"> lib.dll</span><span style="color:#9ECBFF"> lib.go</span></span></code></pre>
</details>
<p>If you get an error saying something like:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># runtime/cgo</span></span>
<span class="line"><span style="color:#B392F0">cc1:</span><span style="color:#9ECBFF"> sorry,</span><span style="color:#9ECBFF"> unimplemented:</span><span style="color:#9ECBFF"> 64-bit</span><span style="color:#9ECBFF"> mode</span><span style="color:#9ECBFF"> not</span><span style="color:#9ECBFF"> compiled</span><span style="color:#9ECBFF"> in</span></span></code></pre>
<p>You need to <a href="#prepping-cgo">go back</a> and setup your C compiler properly. If you now have two new files file called <code>lib.dll</code>/<code>lib.so</code> and <code>lib.h</code> you‚Äôre ready for the python part. Your folder should look something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>üìÇ</span></span>
<span class="line"><span>‚îú‚îÄ üìÑgo.mod</span></span>
<span class="line"><span>‚îú‚îÄ üìÑlib.go</span></span>
<span class="line"><span>‚îú‚îÄ üìÑlib.dll or üìÑlib.so</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄüìÑlib.h</span></span></code></pre>
<h3 id="python">Python</h3>
<p>So to get started with python let‚Äôs create a new file called <code>testing.py</code>. Your directory should look like this after:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>üìÇ</span></span>
<span class="line"><span>‚îú‚îÄ üìÑtesting.py</span></span>
<span class="line"><span>‚îú‚îÄ üìÑgo.mod</span></span>
<span class="line"><span>‚îú‚îÄ üìÑlib.go</span></span>
<span class="line"><span>‚îú‚îÄ üìÑlib.dll or üìÑlib.so</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄüìÑlib.h</span></span></code></pre>
<p>So, now we‚Äôre going to use 2 built in python modules to help us import our code <a href="https://docs.python.org/3/library/ctypes.html"><code>ctypes</code></a> and <a href="https://docs.python.org/3/library/platform.html"><code>platform</code></a>. To import our file properly we will need <a href="https://docs.python.org/3/library/ctypes.html#ctypes.LibraryLoader.LoadLibrary"><code>ctypes.cdll.LoadLibrary()</code></a>, and we will use the <code>platform</code> module to determine which file to load. Here‚Äôs the code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span></code></pre>
<p><code>lib</code> is now a CDLL, which acts similar to a python module. To keep things simple lets start with trying out the <code>Greeting()</code> function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.Greeting()</span></span></code></pre>
<p>We get our original <code>Hello from Go!</code> great! Now for the variadic functions. Like go we have some custom types we need to be aware of to convert:</p>
























































































































<table><thead><tr><th>Python type</th><th>C type</th><th><code>ctypes</code> type</th></tr></thead><tbody><tr><td><code>bool</code></td><td><code>_Bool</code></td><td><code>c_bool</code></td></tr><tr><td>1-character <code>bytes</code> object</td><td><code>char</code></td><td><code>c_char</code></td></tr><tr><td>1-character <code>str</code></td><td><code>wchar_t</code></td><td><code>c_wchar</code></td></tr><tr><td><code>int</code></td><td><code>char</code></td><td><code>c_byte</code></td></tr><tr><td><code>int</code></td><td><code>unsigned char</code></td><td><code>c_ubyte</code></td></tr><tr><td><code>int</code></td><td><code>short</code></td><td><code>c_short</code></td></tr><tr><td><code>int</code></td><td><code>unsigned short</code></td><td><code>c_ushort</code></td></tr><tr><td><code>int</code></td><td><code>int</code></td><td><code>c_int</code></td></tr><tr><td><code>int</code></td><td><code>unsigned int</code></td><td><code>c_uint</code></td></tr><tr><td><code>int</code></td><td><code>long</code></td><td><code>c_long</code></td></tr><tr><td><code>int</code></td><td><code>unsigned long</code></td><td><code>c_ulong</code></td></tr><tr><td><code>int</code></td><td><code>__int64</code> or <code>long long</code></td><td><code>c_longlong</code></td></tr><tr><td><code>int</code></td><td><code>unsigned __int64</code> or <code>unsigned long long</code></td><td><code>c_ulonglong</code></td></tr><tr><td><code>int</code></td><td><code>size_t</code></td><td><code>c_size_t</code></td></tr><tr><td><code>int</code></td><td><code>ssize_t</code> or <code>Py_ssize_t</code></td><td><code>c_ssize_t</code></td></tr><tr><td><code>int</code></td><td><code>time_t</code></td><td><code>c_time_t</code></td></tr><tr><td><code>float</code></td><td><code>float</code></td><td><code>c_float</code></td></tr><tr><td><code>float</code></td><td><code>double</code></td><td><code>c_double</code></td></tr><tr><td><code>float</code></td><td><code>long double</code></td><td><code>c_longdouble</code></td></tr><tr><td><code>bytes</code> object or <code>None</code></td><td><code>char*</code> (NUL terminated)</td><td><code>c_char_p</code></td></tr><tr><td><code>str</code> or <code>None</code></td><td><code>wchar_t*</code> (NUL terminated)</td><td><code>c_wchar_p</code></td></tr><tr><td><code>int</code> or <code>None</code></td><td><code>void*</code></td><td><code>c_void_p</code></td></tr></tbody></table>
<p>*<em>You can see an up-to-date version <a href="https://docs.python.org/3/library/ctypes.html#fundamental-data-types">here</a></em></p>
<p>Or simply:</p>
<p><img src="/tech/blog/python-plus-go/python-ctypes-conversions.excalidraw.png" alt=""></p>
<p>Now we know the types we have to tell python what the function takes in (<code>argtypes</code>) and returns <code>restype</code>, so for <code>factorial()</code> we do:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_int</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup factorial function</span></span>
<span class="line"><span style="color:#E1E4E8">lib.factorial.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.factorial.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_int</span></span></code></pre>
<p>we can then run it using:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">n:</span><span style="color:#79B8FF">int</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.factorial(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">) </span><span style="color:#6A737D"># 3628800</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">type</span><span style="color:#E1E4E8">(result) </span><span style="color:#6A737D"># &#x3C;class 'int'></span></span></code></pre>
<p>Unlike go, python immediately converts the value from the function call for us. So the full data pipeline is:</p>
<p><img src="/tech/blog/python-plus-go/full-pipeline-conversions.excalidraw.png" alt=""></p>
<details><summary>The full code (collapsed for easy reading)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function to greet someone</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export Greeting</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Greeting</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello from Go!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function to calculate the factorial of a number n</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Parameters</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// n (int): The integer to calculate the factorial of</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Returns</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// int: The factorial of n</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Factorial</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n</span></span>
<span class="line"><span style="color:#E1E4E8">	lastVal </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#F97583"> range</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n) {</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> lastVal </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			result </span><span style="color:#F97583">*=</span><span style="color:#E1E4E8"> lastVal</span></span>
<span class="line"><span style="color:#E1E4E8">			lastVal </span><span style="color:#F97583">-=</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// The cgo binding to call the Factorial Function through</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Parameters</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// n (C.int): The integer to calculate the factorial of</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Returns</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// C.int: The factorial of n</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export factorial</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> factorial</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	goN </span><span style="color:#F97583">:=</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n)            </span><span style="color:#6A737D">// Convert to go integer</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> Factorial</span><span style="color:#E1E4E8">(goN) </span><span style="color:#6A737D">// Get go integer result</span></span>
<span class="line"><span style="color:#E1E4E8">	r </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(result)       </span><span style="color:#6A737D">// Convert to C integer</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> r</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// This has to stay here, but leave it empty</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>testing.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_int</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D"># Simple idempotent function call</span></span>
<span class="line"><span style="color:#E1E4E8">lib.Greeting()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Variadic function (with arguments/returns)</span></span>
<span class="line"><span style="color:#E1E4E8">lib.factorial.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.factorial.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">n </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The factorial of </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">n</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> is </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">lib.factorial(n)</span><span style="color:#79B8FF">}</span><span style="color:#79B8FF"> {type</span><span style="color:#E1E4E8">(lib.factorial(n))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span></code></pre>
</details>
<h2 id="the-hard-part">The hard part</h2>
<p>Yes, all that really was the easy part, now comes some of the hard stuff. I want to make clear before we start this section I am not the best C programmer, so some of this is not easy for me either. There may be better ways to handle this that I‚Äôm not aware of, but I‚Äôm doing my best here. To put it bluntly the hard part of all this is memory management. Compared to even traditional C this sort of memory management is harder than you would think because you need to synchronize everything together. The fact that multiple environments are accessing shared memory makes it incredibly easy to accidentally <a href="https://owasp.org/www-community/vulnerabilities/Doubly_freeing_memory">double-free</a>, <a href="https://owasp.org/www-community/vulnerabilities/Memory_leak">memory leak</a>, <a href="https://owasp.org/www-community/vulnerabilities/Null_Dereference">NULL dereference</a> and <a href="https://owasp.org/www-community/vulnerabilities/Using_freed_memory">use-after-free</a> (amoung other vulnerabilities).</p>
<p>So I will share some tips at the end for rules to follow to help avoid these problems.</p>
<h3 id="strings">Strings</h3>
<p>To understand this for those of us that don‚Äôt use C much, the reason strings are awkward is because <strong>strings don‚Äôt really exist</strong>. Strings are just an array of bytes, essentially a chunk of memory, with a bit of data in it. From there we interpret each byte according to it‚Äôs <a href="https://kieranwood.ca/compsci/Programming/Encodings">encoding</a>. For strings this means we might get something like this:</p>
<p><img src="/tech/blog/python-plus-go/string-memory-allocation.excalidraw.png" alt=""></p>
<p>In this case that means our string is just actually a pointer to the first byte (<code>0x48</code>), and then we keep track of the length <code>6 bytes</code>. So our ‚Äústring‚Äù is just an array of <code>[0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x00]</code> in C. When we want to use the string, we then chuck those raw bytes through an encoding (in this case ASCII) to get the characters back out again. But, the length is variable, so the only thing we store is the pointer to the first byte (hence <code>char*</code> being a pointer to the first <code>char</code>), and we handle the length ourselves. Unlike integers or floating point numbers which all have a fixed size, making it so C can clean them up for us. Because of this we also have to handle cleanup ourselves (with <code>C.free()</code> and a pointer to the data). This cleanup is dangerous because <strong>we are responsible</strong>, which means if we‚Äôre wrong, we can do some damage.</p>
<p>Working with strings the way I will explain is not terrible because for the most part we are just taking that string, converting it to a go/python string, and working with it internally in the language. Anything that is internal to Go is managed by Go, anything that crosses the go-python boundary, handle the cleanup in python (with some help from go).</p>
<p>With that said, here‚Äôs some example code that looks similar to what we‚Äôve seen before:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// A function that generates a string to greet someone</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> GreetS</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">!</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">How's your day?</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So in this case we have a string being passed in, and one being returned.</p>
<p>Now comes the hairy part of this. You <em>can</em> free the memory in the go function, I would recommend using <a href="https://go.dev/tour/flowcontrol/12"><code>defer</code></a> if you decide to. However, python considers itself responsible for certain datatypes that <strong>it creates</strong>. <code>name</code> is passed in <strong>from python</strong>, which means that python will clean the memory itself!</p>
<p>The below code for example <strong>WILL NOT WORK WITH PYTHON</strong>, but might be useful if you‚Äôre writing code for <code>C</code> or other memory unmanaged languages:</p>
<div class="danger-banner">
<p>This code doesn‚Äôt work with python and <strong>will <a href="https://owasp.org/www-community/vulnerabilities/Doubly_freeing_memory">double-free</a></strong></p>
</div>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export greet_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> greet_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    defer</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(name))        </span><span style="color:#6A737D">// Clean up memory at the end of the function</span></span>
<span class="line"><span style="color:#E1E4E8">	goName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name)                </span><span style="color:#6A737D">// Convert input to go string</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"HELLO </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, goName) </span><span style="color:#6A737D">// Get a result as a go string</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(result)                  </span><span style="color:#6A737D">// Return a C-compatible string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So, returning back to our code that does work (without the <code>C.free()</code>), we can look at how it works in python:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup our functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result:</span><span style="color:#79B8FF">bytes</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> lib.greet_string(name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>*<em>When decoding I did <code>errors='replace'</code> there are some weird encoding errors when using <code>encoding='strict'</code> (the default) that I encountered, so this is a more relaxed decoding, but it could lead to issues depending on your character set</em></p>
<p>Now if we compile the go code, and run the python code, everything works so we‚Äôre all good right? Wrong, we actually just leaked some memory by accident. Like I said before, variables created by python are managed by it, so our <code>name</code> variable will be cleaned up properly, but we never cleaned up the <code>result</code> variable.  When python created <code>name</code> it took ownership of the memory, and when it passed it in, it still had ownership. When we created the <code>result</code> variable, it was <strong>created in Go</strong> using <code>C.Cstring</code>, which ran <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/malloc?view=msvc-170"><code>malloc()</code></a> (a custom version of it) under the hood. So the memory was created in C by go, but it‚Äôs never told when the reference dies, so it‚Äôs never GC‚Äôd. Here‚Äôs a diagram following the execution of the python program:</p>
<p><img src="/tech/blog/python-plus-go/unfreed-memory.excalidraw.png" alt=""></p>
<p>To fix this we can write a go function that takes in a C string and frees it:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export free_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">str</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(str))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Then we can call the new <code>free_string()</code> function in our python code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string.restype </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result:</span><span style="color:#79B8FF">bytes</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> lib.greet_string(name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string(result)</span></span></code></pre>
<p>Perfect, so we‚Äôre good right? Kinda, but here‚Äôs why we use languages like Go and python in the first place. How do you <strong>know</strong> you‚Äôre doing the right thing with <code>lib.free_string()</code>? What happens if an error occurs right after we allocate <code>result</code>? The memory is never cleaned.</p>
<p>The harsh reality is that you just need to always be careful no matter what your solution is. I tried about 15 different ones during the writting of this article, and the reality is that there‚Äôs no silver bullet. The best of the janky potential ‚Äúsolutions‚Äù I can suggest <code>__del__()</code> and <code>try finally</code>. <code>try finally</code> is the easiest, you just do something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#79B8FF">...</span><span style="color:#6A737D"> # Other code above</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.greet_string(name)</span></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string(result)</span></span></code></pre>
<p>The <code>finally</code> keyword means that even if there‚Äôs an error after <code>result</code> is created, <code>lib.free_string(result)</code> will be run. This works pretty well, but we need to remember to do it, and it can get complicated if we do something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.greet_string(name)</span></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    result2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.greet_string(name)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string(result)</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string(result2)</span></span></code></pre>
<p>What happens if an error occurs while <code>result2</code> is being assigned? Then when we free in our <code>finally</code> block, we‚Äôre freeing unused memory, which is bad, my head hurts. This solution is not great, and in general you should try to avoid it by itself unless you‚Äôre passing and receiving 1 variable at a time.</p>
<p>Behind janky door number 2 is <code>__del__()</code>. This is a <a href="https://www.geeksforgeeks.org/dunder-magic-methods-python/">dunder/magic method</a> that allows you to override what happens when python cleans up objects. This isn‚Äôt a very handy option for this example, but when we start looking at classes below it will be. Let‚Äôs see how this could work for our above example first:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> EvilString</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __init__</span><span style="color:#E1E4E8">(self:</span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">, value:</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#E1E4E8">.value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __str__</span><span style="color:#E1E4E8">(self) -> </span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">.value.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __del__</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_string(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">.value)</span></span></code></pre>
<p>So, when we ask python to convert the value to a string, we get what we expect, and python will automatically clean up the references when we no longer need them, great right? You probably know where this is going. Here‚Äôs some code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#79B8FF">...</span><span style="color:#6A737D"> # Other code</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> EvilString</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __init__</span><span style="color:#E1E4E8">(self:</span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">, value:</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#E1E4E8">.value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __str__</span><span style="color:#E1E4E8">(self) -> </span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">.value.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __del__</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_string(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">.value)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">name2 </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran2"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> EvilString(lib.greet_string(name))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">result2:</span><span style="color:#79B8FF">str</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">(EvilString(lib.greet_string(name2)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result2</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>So what‚Äôs the issue? The first <code>result</code> variable is great, no issues! But the second print statement never happens. The program silently crashes before it runs. No traceback, no errors, just dies. The output is actually this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#E1E4E8">> </span><span style="color:#9ECBFF">python</span><span style="color:#9ECBFF"> testing.py</span></span>
<span class="line"><span style="color:#B392F0">The</span><span style="color:#9ECBFF"> result</span><span style="color:#9ECBFF"> is:</span><span style="color:#9ECBFF"> Hello</span><span style="color:#9ECBFF"> Kieran</span></span>
<span class="line"><span style="color:#B392F0">How</span><span style="color:#B392F0">'s your day?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">Deallocating string Hello Kieran2</span></span>
<span class="line"><span style="color:#B392F0">How'</span><span style="color:#B392F0">s</span><span style="color:#9ECBFF"> your</span><span style="color:#9ECBFF"> day?</span></span></code></pre>
<p>So what‚Äôs wrong here. It‚Äôs actually the string conversion for <code>result2</code> the lines are:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">name2 </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran2"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result2:</span><span style="color:#79B8FF">str</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">(EvilString(lib.greet_string(name2)))</span></span></code></pre>
<p>To make things complicated, you would assume the code below is equivalent, but actually this code would work:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">name2 </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran2"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">step1 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.greet_string(name2)</span></span>
<span class="line"><span style="color:#E1E4E8">step2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> EvilString(step1)</span></span>
<span class="line"><span style="color:#E1E4E8">result2:</span><span style="color:#79B8FF">str</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">(step2)</span></span></code></pre>
<p>Looking at the print logs we can see what‚Äôs happening. The reason is how python handles objects. Python counts references, and then cleans when nothing else needs it. Because we‚Äôre only creating the <code>EvilString</code> to run the <code>str()</code> on it in the original code, the <code>EvilString</code> value is GC‚Äôd after <code>str()</code> runs on it. This means the reference to the underlying <code>value</code> is dereferenced <strong>before</strong> the <code>print()</code> call is made, so the first code would actually expand under the hood to look like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">name2 </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran2"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">step1 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.greet_string(name2)</span></span>
<span class="line"><span style="color:#E1E4E8">step2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> EvilString(step1)</span></span>
<span class="line"><span style="color:#E1E4E8">result2:</span><span style="color:#79B8FF">str</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">(step2)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">del</span><span style="color:#E1E4E8"> step2 </span><span style="color:#6A737D"># Also breaks result2 because the pointer to the value is gone</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result2</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>Here‚Äôs a diagram of what‚Äôs happening:</p>
<p><img src="/tech/blog/python-plus-go/result2-memory.excalidraw.png" alt=""></p>
<p>So this approach also has it‚Äôs own problems to watch out for. Like I said, there‚Äôs no silver bullet, this sort of programming is just hard sometimes.</p>
<details><summary>The full code (collapsed for easy reading)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">unsafe</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function that generates a string to greet someone</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Parameters</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// name(string): The name of the person being greeted</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Returns</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// string: a greeting</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> GreetS</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">How's your day?</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// A function that generates a string to greet someone</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Parameters</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// name(*C.char): The name of the person being greeted</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Returns</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// *C.char: a greeting to display to the user</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export greet_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> greet_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	goName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name) </span><span style="color:#6A737D">// Convert input to go string</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> GreetS</span><span style="color:#E1E4E8">(goName)   </span><span style="color:#6A737D">// Get a result as a go string</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(result)   </span><span style="color:#6A737D">// Return a C-compatible string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Used to free a C string after use</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// # Parameters</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// str (*C.char): The string to free</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">//export free_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">str</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(str))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// This has to stay here, but leave it empty</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>testing.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.greet_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c_char_p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string.restype </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Manually cleaning up memory</span></span>
<span class="line"><span style="color:#E1E4E8">name2 </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result2:</span><span style="color:#79B8FF">str</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> lib.greet_string(name2)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result2.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string(result2)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Class-based approach with __del__()</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> EvilString</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __init__</span><span style="color:#E1E4E8">(self:</span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">, value:</span><span style="color:#79B8FF">bytes</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'EvilString'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#E1E4E8">.value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __str__</span><span style="color:#E1E4E8">(self) -> </span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">.value.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#79B8FF"> __del__</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_string(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">.value)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "Kieran"</span><span style="color:#E1E4E8">.encode()</span></span>
<span class="line"><span style="color:#E1E4E8">result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> EvilString(lib.greet_string(name))</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"The result is: </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">result</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Below code errors out </span></span>
<span class="line"><span style="color:#6A737D"># name2 = "Kieran2".encode()</span></span>
<span class="line"><span style="color:#6A737D"># result2:str = str(EvilString(lib.greet_string(name2)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># print(f"The result is: {result2}")</span></span></code></pre>
</details>
<h3 id="classes--slices">Classes &#x26; Slices</h3>
<p>Classes &#x26; slices is where the memory issues get cranked up to 11. For our ‚Äúsimpler‚Äù types (<code>int</code>s, <code>float</code>s, etc.) there is a set length (i.e. <code>int8</code> is always a set size), which means it‚Äôs easier to pass around because you have <strong>certain guarentees for sizes</strong>. For strings, C stores <strong>just the bytes</strong>, the encoding is a separate system that‚Äôs up to whatever is interpreting those bytes. The same is true for structs &#x26; slices, we need to allocate the space for the struct/slices ourselves, and manage how much memory is needed ourselves. Imagine the struct:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	name  </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	age   </span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The C equivalent would be:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">typedef</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">	char*</span><span style="color:#E1E4E8"> name;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8"> age;</span></span>
<span class="line"><span style="color:#F97583">	char*</span><span style="color:#E1E4E8"> email;</span></span>
<span class="line"><span style="color:#E1E4E8">} User;</span></span></code></pre>
<p>So to create this struct we would need to allocate enough space for:</p>
<ul>
<li>The two char <strong>pointers</strong> (The data is a separate allocation)</li>
<li>The integer</li>
</ul>
<p>To do this, we need to create the struct in go, and add the equivalent struct to our C environment. It looks something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct{</span></span>
<span class="line"><span style="color:#6A737D">	char* name;</span></span>
<span class="line"><span style="color:#6A737D">	int age;</span></span>
<span class="line"><span style="color:#6A737D">	char* email;</span></span>
<span class="line"><span style="color:#6A737D">} User;</span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	name  </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	age   </span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We now have a type of <code>C.User</code> that is created and looks something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">	name </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span></span>
<span class="line"><span style="color:#E1E4E8">	age </span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So, to create a <code>C.User</code> and return it in a function we first allocate the memory for the struct. Since we‚Äôre constructing the struct in go, this requires knowing the size, then running <code>C.malloc()</code> and casting the resulting pointer to our new type:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">age</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">email</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6A737D">	// Get the estimated size</span></span>
<span class="line"><span style="color:#E1E4E8">	memoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Convert to the actual size</span></span>
<span class="line"><span style="color:#E1E4E8">	CMemoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(memoryFootprint)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// allocate the struct and cast to a `C.User` pointer</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(CMemoryFootprint))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Once we‚Äôve allocted, now we can create the struct with our values and return it:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export create_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">age</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">email</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// allocate the struct</span></span>
<span class="line"><span style="color:#E1E4E8">	memoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})</span></span>
<span class="line"><span style="color:#E1E4E8">	CMemoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(memoryFootprint)</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(CMemoryFootprint))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Instantiate the struct with it's values</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">user </span><span style="color:#F97583">=</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		name:  C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name)),</span></span>
<span class="line"><span style="color:#E1E4E8">		age:   age,</span></span>
<span class="line"><span style="color:#E1E4E8">		email: C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(email)),</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>You may be wondering why we didn‚Äôt have to do any fancy allocations for <code>name</code> and <code>email</code>, we don‚Äôt have to because <code>C.CString()</code> handles that complexity for us. To be safe, get in the habit of writing a <code>free</code> function after you add a C struct in. So in our case we would have:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export free_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userReference</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.name))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.email))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Here comes the tricky bit. You see in our <code>free_user</code> function we‚Äôre freeing the <code>name</code>, <code>email</code>, then the whole struct, but what about <code>age</code>? Well, like I said before <code>int</code> and other primitive types have set lengths, and C will deal with it for us, so we don‚Äôt need to de-allocate them manually. But we do have to free the memory for the two strings, since they were dynamically allocated (same is true if you use <code>C.malloc()</code> for anything). So, we get the pointer to the string using <code>unsafe.Pointer</code>, and free it. Once we‚Äôve cleaned up the values for individual values of the struct, then clean the struct.</p>
<p>Now, let‚Äôs look at a useful pattern for tying this together with python.</p>
<h4 id="pattern-for-classes">Pattern for classes</h4>
<p>First things first, to make this work you will have to create 4 separate struct/classes. The first 2 are in Go and CGo, and the other 2 are in python. This seems like a lot (and it is), but this is for a good reason. You can do it other ways, but this is what I recommend.</p>
<p>Lets start with a modified version of the go code we saw before:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct{</span></span>
<span class="line"><span style="color:#6A737D">	char* name;</span></span>
<span class="line"><span style="color:#6A737D">	int age;</span></span>
<span class="line"><span style="color:#6A737D">	char* email;</span></span>
<span class="line"><span style="color:#6A737D">} User;</span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">github.com/brianvoe/gofakeit</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	name  </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	age   </span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{gofakeit.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), gofakeit.</span><span style="color:#B392F0">Number</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">), gofakeit.</span><span style="color:#B392F0">Email</span><span style="color:#E1E4E8">()}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">age</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">email</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// allocate the struct</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create the struct and it's poitners</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">user </span><span style="color:#F97583">=</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		name:  C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name)),</span></span>
<span class="line"><span style="color:#E1E4E8">		age:   age,</span></span>
<span class="line"><span style="color:#E1E4E8">		email: C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(email)),</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_random_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Create a random go version of the user</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create C-compatible versions of variables</span></span>
<span class="line"><span style="color:#E1E4E8">	cName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(res.name)</span></span>
<span class="line"><span style="color:#E1E4E8">	cEmail </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(res.email)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate necessary memory</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Assign values to freshly created struct</span></span>
<span class="line"><span style="color:#E1E4E8">	user.name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cName</span></span>
<span class="line"><span style="color:#E1E4E8">	user.age </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(res.age)</span></span>
<span class="line"><span style="color:#E1E4E8">	user.email </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cEmail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userReference</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.name))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.email))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// Do nothing</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Make sure to run <code>go mod tidy</code> to download the library from github. We can now use this to create random <code>User</code>‚Äôs and then pipe those out as a <code>C.User</code> via the <code>create_random_user()</code> function. So our first two structs are down (<code>User</code> and <code>C.User</code>). Now we need the python side, so let‚Äôs create those two classes first, and bring in the rest of the code slowly:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> dataclasses </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> dataclass</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> c_char_p, c_int, Structure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Define the C-compatible User struct in Python</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CUser</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"age"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"email"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># The pure python class</span></span>
<span class="line"><span style="color:#B392F0">@dataclass</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> User</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    name:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    age:</span><span style="color:#79B8FF">int</span></span>
<span class="line"><span style="color:#E1E4E8">    email:</span><span style="color:#79B8FF">str</span></span></code></pre>
<p>Now let‚Äôs setup those functions from before, to do this we will use a <code>POINTER</code> object that wraps our <code>CUser</code> struct:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p, c_int, Structure, </span><span style="color:#79B8FF">POINTER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(CUser)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_random_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p, c_int, c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span></code></pre>
<p>We can then use the code with:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    user_pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_user(</span><span style="color:#9ECBFF">"Kieran"</span><span style="color:#E1E4E8">.encode(), </span><span style="color:#79B8FF">21</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"kieran@canadiancoding.ca"</span><span style="color:#E1E4E8">.encode())</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_pointer) </span><span style="color:#6A737D"># &#x3C;__main__.LP_CUser object at 0x0000022BE95AD650></span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_pointer.contents) </span><span style="color:#6A737D"># &#x3C;__main__.CUser object at 0x0000022BE95AD5D0></span></span>
<span class="line"><span style="color:#6A737D">	# Prints: user_pointer.contents.name=b'Kieran', user_pointer.contents.age=21, user_pointer.contents.email=b'kieran@canadiancoding.ca'</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.name</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.age</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.email</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_user(user_pointer)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cleared user"</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>So you can see we have the pointer (of type <code>LP_CUser</code>), and then the contents can be found in <code>LP_CUser.contents</code> (of type <code>CUser</code>). Remember that our strings come in as a <code>Bytes</code>, that we need to <code>encode()</code> to get the text back out. So, to make this easier, let‚Äôs modify our <code>User</code> class so that we can add a class method to instantiate it via Go/C:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> traceback</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> dataclass </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> dataclass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">@dataclass</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> User</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    name:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    age:</span><span style="color:#79B8FF">int</span></span>
<span class="line"><span style="color:#E1E4E8">    email:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_user_from_C</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">, name:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">, age:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">, email:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_user(name.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">), age, email.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.name.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> name</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.age </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> age</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.email.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> email</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_random_user()</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span></code></pre>
<p>Then to use the class we can do:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#E1E4E8">me </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User.create_user_from_C(</span><span style="color:#9ECBFF">"Kieran"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">26</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"kieran@canadiancoding.ca"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">rando </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User.create_random_user()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(me) </span><span style="color:#6A737D"># User(name='Kieran', age=26, email='kieran@canadiancoding.ca')</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(rando) </span><span style="color:#6A737D"># User(name='Pearl Pagac', age=40, email='margieledner@schiller.org')</span></span></code></pre>
<p>To understand the memory here‚Äôs a diagram:</p>
<p><img src="/tech/blog/python-plus-go/struct-examples.excalidraw.png" alt=""></p>
<details><summary>The full code (collapsed for easy reading)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct{</span></span>
<span class="line"><span style="color:#6A737D">	char* name;</span></span>
<span class="line"><span style="color:#6A737D">	int age;</span></span>
<span class="line"><span style="color:#6A737D">	char* email;</span></span>
<span class="line"><span style="color:#6A737D">} User;</span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">unsafe</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">github.com/brianvoe/gofakeit</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	name  </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	age   </span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{gofakeit.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), gofakeit.</span><span style="color:#B392F0">Number</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">), gofakeit.</span><span style="color:#B392F0">Email</span><span style="color:#E1E4E8">()}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CreateRandomUsers</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">count</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">[]</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">, count)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> count {</span></span>
<span class="line"><span style="color:#E1E4E8">		result[i] </span><span style="color:#F97583">=</span><span style="color:#F97583"> *</span><span style="color:#B392F0">createRandomUser</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">age</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">email</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// allocate the struct</span></span>
<span class="line"><span style="color:#E1E4E8">	memoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})</span></span>
<span class="line"><span style="color:#E1E4E8">	CMemoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(memoryFootprint)</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(CMemoryFootprint))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create the struct and it's poitners</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">user </span><span style="color:#F97583">=</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		name:  C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name)),</span></span>
<span class="line"><span style="color:#E1E4E8">		age:   age,</span></span>
<span class="line"><span style="color:#E1E4E8">		email: C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(email)),</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_random_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Create a random go version of the user</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Expand go versions of variables</span></span>
<span class="line"><span style="color:#E1E4E8">	goName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.name</span></span>
<span class="line"><span style="color:#E1E4E8">	goEmail </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.email</span></span>
<span class="line"><span style="color:#E1E4E8">	age </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.age</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create C-compatible versions of variables</span></span>
<span class="line"><span style="color:#E1E4E8">	cName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(goName)</span></span>
<span class="line"><span style="color:#E1E4E8">	cEmail </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(goEmail)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate necessary memory</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Assign values to freshly created struct</span></span>
<span class="line"><span style="color:#E1E4E8">	user.name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cName</span></span>
<span class="line"><span style="color:#E1E4E8">	user.age </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(age)</span></span>
<span class="line"><span style="color:#E1E4E8">	user.email </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cEmail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userReference</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.name))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.email))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// Do nothing</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p><code>testing.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> traceback</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> dataclasses </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> dataclass</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p, c_int, Structure, </span><span style="color:#79B8FF">POINTER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Define the C-compatible User struct in Python</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CUser</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"age"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"email"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.free_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(CUser)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_random_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p, c_int, c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    user_pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_user(</span><span style="color:#9ECBFF">"Kieran"</span><span style="color:#E1E4E8">.encode(), </span><span style="color:#79B8FF">21</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"kieran@canadiancoding.ca"</span><span style="color:#E1E4E8">.encode())</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_pointer)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(user_pointer.contents)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.name</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.age</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_pointer.contents.email</span><span style="color:#F97583">=</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_user(user_pointer)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cleared user"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">@dataclass</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> User</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    name:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    age:</span><span style="color:#79B8FF">int</span></span>
<span class="line"><span style="color:#E1E4E8">    email:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_user_from_C</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">, name:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">, age:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">, email:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_user(name.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">), age, email.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.name.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> name</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.age </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> age</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.email.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> email</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Something went wrong, free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_random_user()</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Something went wrong, free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">me </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User.create_user_from_C(</span><span style="color:#9ECBFF">"Kieran"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">26</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"kieran@canadiancoding.ca"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">rando </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User.create_random_user()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(me)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(rando)</span></span></code></pre>
</details>
<h4 id="slices">Slices</h4>
<p>Slices also get a bit weird, but the pattern is a bit simpler for them. Take a function that returns a slice, say:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, n)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		results </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(results, </span><span style="color:#B392F0">Fib</span><span style="color:#E1E4E8">(i))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Typically with integers we don‚Äôt need to mess around with pointers. If we wanted to wrap <code>Fib()</code> for example, we could just do:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> fib</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(n))</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(res)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>But with a slice we take the base type, and add an extra pointer, so for an integer slice, like <code>FibSequence()</code> we do:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> fib_sequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Code in here</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So at the end we need a pointer to the integers, got it. Now we can first get our results from <code>FibSequence()</code>, then we need to do pointer arithmetic. Essentially we need to calculate the size of the array, and allocate that memory. We can do that with this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// Allocate memory for an array of C ints (int*)</span></span>
<span class="line"><span style="color:#E1E4E8">sizeOfArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(n)</span></span>
<span class="line"><span style="color:#E1E4E8">sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sizeOfArray </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfEachElement</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Allocate the necessary memory</span></span>
<span class="line"><span style="color:#E1E4E8">cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span></code></pre>
<p>Now that we have the array, we need to fill it with data. To do this we determine the starting location of the array, the size of each element, and the current index/offset into the array:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i, currentNumber </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> results {</span></span>
<span class="line"><span style="color:#E1E4E8">	locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">	offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                      </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))       </span><span style="color:#6A737D">// Size of a single value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfEachElement))</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(currentNumber) </span><span style="color:#6A737D">// Convert go int to C int and insert at location in array</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So since our memory is allocated, we‚Äôre manually casting our location in memory to a pointer of a <code>C.int</code> then filling it with data in the last line. We do this for each element, and we‚Äôve manually allocated and filled our array. All together it looks like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export fib_sequence</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> fib_sequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(n))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for an array of C ints (int*)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(n)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sizeOfArray </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfEachElement</span></span>
<span class="line"><span style="color:#E1E4E8">	cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, currentNumber </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> results {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                      </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))       </span><span style="color:#6A737D">// Size of a single value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfEachElement))</span></span>
<span class="line"><span style="color:#F97583">		*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(currentNumber) </span><span style="color:#6A737D">// Convert go int to C int and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> cArray</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Now we just setup a function to clean up our array, which is pretty easy since integers are a fixed size:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export free_int_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_int_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">array</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(array))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Now we write and test the python side:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_int, </span><span style="color:#79B8FF">POINTER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(c_int)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_int_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">n </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#E1E4E8">ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.fib_sequence(n)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(n):</span></span>
<span class="line"><span style="color:#E1E4E8">        results.append(ptr[i])</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(results) </span><span style="color:#6A737D"># [1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_int_array(ptr)</span></span></code></pre>
<details><summary>The full code (collapsed for easy reading)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">unsafe</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, n)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		results </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(results, </span><span style="color:#B392F0">Fib</span><span style="color:#E1E4E8">(i))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export fib_sequence</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> fib_sequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(n))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for an array of C ints (int*)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(n)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sizeOfArray </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfEachElement</span></span>
<span class="line"><span style="color:#E1E4E8">	cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, currentNumber </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> results {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                      </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))       </span><span style="color:#6A737D">// Size of a single value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfEachElement))</span></span>
<span class="line"><span style="color:#F97583">		*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(currentNumber) </span><span style="color:#6A737D">// Convert go int to C int and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> cArray</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_int_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_int_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">array</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(array))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// Do nothing</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>testing.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p, c_int, </span><span style="color:#79B8FF">POINTER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(c_int)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_int_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">n </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#E1E4E8">ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.fib_sequence(n)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(n):</span></span>
<span class="line"><span style="color:#E1E4E8">        results.append(ptr[i])</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(results)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_int_array(ptr)</span></span></code></pre>
</details>
<p>This will work for any of the simple types, but what about strings and structs?</p>
<h4 id="all-together-now">All together now</h4>
<p>This leads to our final question, how do we return an array of structs/strings. For both the answer is the same. We combine what we learned about slices with what we learned about structs and strings. Here‚Äôs a bit of go code that takes in a string, and multiplies it by a number suggested, then returns a string slice of those values:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> MultiplyString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputString</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, count)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> count; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(result, inputString)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Like I said before, we take our result type and add another pointer to it. So, since we usually return <code>*C.char</code> for strings, we instead use <code>**C.char</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> multiply_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputString</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// code here</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Everything else looks pretty familiar, we allocate our memory:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// Allocate memory for an array of C string pointers (char**)</span></span>
<span class="line"><span style="color:#E1E4E8">amountOfElements </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> amountOfElements </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfSingleElement</span></span>
<span class="line"><span style="color:#E1E4E8">stringArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span></code></pre>
<p>*<em>Weirdly enough for strings we use <code>uintptr(0)</code> since the ‚Äúsize‚Äù is actually just the size of the pointer. For structs you use an empty struct, i.e. for a <code>C.User</code> struct from earlier you would use <code>unsafe.Sizeof(C.User{})</code></em></p>
<p>Then fill with our data:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i, currentString </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> res {</span></span>
<span class="line"><span style="color:#6A737D">	// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">	locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(stringArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">	offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                           </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))        </span><span style="color:#6A737D">// Size of a single string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfSingleElement))</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(currentString) </span><span style="color:#6A737D">// Convert go string to C string and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Make sure we add a function to clean everything up:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">//export free_string_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_string_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputArray</span><span style="color:#F97583"> **</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(count); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to find the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(inputArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                          </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		memorySizeOfStruct </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))        </span><span style="color:#6A737D">// Size of a single struct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		ptr </span><span style="color:#F97583">:=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">memorySizeOfStruct))</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(ptr))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(inputArray))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Then in python:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.multiply_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p, c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.multiply_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(c_char_p)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_char_p), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"><span style="color:#E1E4E8">r </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.multiply_string(</span><span style="color:#9ECBFF">"Hello"</span><span style="color:#E1E4E8">.encode(), count)</span></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#E1E4E8">        result.append(r[i].decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(result) </span><span style="color:#6A737D"># ['Hello', 'Hello', 'Hello', 'Hello', 'Hello']</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string_array(r, count)</span></span></code></pre>
<p>You can find the full code below, with an additional example with a struct</p>
<details><summary>The full code (collapsed for easy reading)</summary>
<p><code>lib.go</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">#include &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">typedef struct{</span></span>
<span class="line"><span style="color:#6A737D">	char* name;</span></span>
<span class="line"><span style="color:#6A737D">	int age;</span></span>
<span class="line"><span style="color:#6A737D">	char* email;</span></span>
<span class="line"><span style="color:#6A737D">} User;</span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">C</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">unsafe</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">github.com/brianvoe/gofakeit</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Fib</span><span style="color:#E1E4E8">(n</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, n)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(n); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		results </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(results, </span><span style="color:#B392F0">Fib</span><span style="color:#E1E4E8">(i))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export fib_sequence</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> fib_sequence</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	results </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> FibSequence</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(n))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for an array of C ints (int*)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(n)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sizeOfArray </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfEachElement</span></span>
<span class="line"><span style="color:#E1E4E8">	cArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, currentNumber </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> results {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(cArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                      </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfEachElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))       </span><span style="color:#6A737D">// Size of a single value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfEachElement))</span></span>
<span class="line"><span style="color:#F97583">		*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(currentNumber) </span><span style="color:#6A737D">// Convert go int to C int and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> cArray</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_int_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_int_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">array</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(array))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> MultiplyString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputString</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, count)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> count; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(result, inputString)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export multiply_string</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> multiply_string</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputString</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> MultiplyString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(inputString), </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(count))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate memory for an array of C string pointers (char**)</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfElements </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count)</span></span>
<span class="line"><span style="color:#E1E4E8">	sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">	amountOfMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> amountOfElements </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> sizeOfSingleElement</span></span>
<span class="line"><span style="color:#E1E4E8">	stringArray </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(amountOfMemory))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, currentString </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> res {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(stringArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                           </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfSingleElement </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))        </span><span style="color:#6A737D">// Size of a single string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		locationInMemory </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfSingleElement))</span></span>
<span class="line"><span style="color:#F97583">		*</span><span style="color:#E1E4E8">locationInMemory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(currentString) </span><span style="color:#6A737D">// Convert go string to C string and insert at location in array</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> stringArray</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_string_array</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_string_array</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">inputArray</span><span style="color:#F97583"> **</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(count); i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to find the string</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(inputArray)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                          </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		memorySizeOfStruct </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))        </span><span style="color:#6A737D">// Size of a single struct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		ptr </span><span style="color:#F97583">:=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">**</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">memorySizeOfStruct))</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(ptr))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(inputArray))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> User</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	name  </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	age   </span><span style="color:#F97583">int</span></span>
<span class="line"><span style="color:#E1E4E8">	email </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{gofakeit.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), gofakeit.</span><span style="color:#B392F0">Number</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">), gofakeit.</span><span style="color:#B392F0">Email</span><span style="color:#E1E4E8">()}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> CreateRandomUsers</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">count</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) []</span><span style="color:#F97583">*</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	result </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">*</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">, count)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> count; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		result[i] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">age</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">email</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// allocate the struct</span></span>
<span class="line"><span style="color:#E1E4E8">	memoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})</span></span>
<span class="line"><span style="color:#E1E4E8">	CMemoryFootprint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(memoryFootprint)</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(CMemoryFootprint))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create the struct and it's poitners</span></span>
<span class="line"><span style="color:#F97583">	*</span><span style="color:#E1E4E8">user </span><span style="color:#F97583">=</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		name:  C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(name)),</span></span>
<span class="line"><span style="color:#E1E4E8">		age:   age,</span></span>
<span class="line"><span style="color:#E1E4E8">		email: C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">GoString</span><span style="color:#E1E4E8">(email)),</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_random_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Create a random go version of the user</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> createRandomUser</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Expand go versions of variables</span></span>
<span class="line"><span style="color:#E1E4E8">	goName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.name</span></span>
<span class="line"><span style="color:#E1E4E8">	goEmail </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.email</span></span>
<span class="line"><span style="color:#E1E4E8">	age </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.age</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create C-compatible versions of variables</span></span>
<span class="line"><span style="color:#E1E4E8">	cName </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(goName)</span></span>
<span class="line"><span style="color:#E1E4E8">	cEmail </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(goEmail)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Allocate necessary memory</span></span>
<span class="line"><span style="color:#E1E4E8">	user </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Assign values to freshly created struct</span></span>
<span class="line"><span style="color:#E1E4E8">	user.name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cName</span></span>
<span class="line"><span style="color:#E1E4E8">	user.age </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(age)</span></span>
<span class="line"><span style="color:#E1E4E8">	user.email </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cEmail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> user</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export create_random_users</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> create_random_users</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	// Create a random go version of the user</span></span>
<span class="line"><span style="color:#E1E4E8">	res </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> CreateRandomUsers</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(count))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	users </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(C.</span><span style="color:#B392F0">malloc</span><span style="color:#E1E4E8">(C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(count) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">size_t</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{}))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	// Create Array of data</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, user </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> res {</span></span>
<span class="line"><span style="color:#E1E4E8">		locationOfArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(users)) </span><span style="color:#6A737D">// Starting point of first byte of slice</span></span>
<span class="line"><span style="color:#E1E4E8">		offsetIntoArray </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)                     </span><span style="color:#6A737D">// The offset for the current element</span></span>
<span class="line"><span style="color:#E1E4E8">		sizeOfSingleStruct </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})     </span><span style="color:#6A737D">// Size of a single struct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">		// Calculate where to put the current struct</span></span>
<span class="line"><span style="color:#E1E4E8">		startPoint </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(locationOfArray </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> offsetIntoArray</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sizeOfSingleStruct)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">		// Get pointer location for current struct</span></span>
<span class="line"><span style="color:#E1E4E8">		currentUser </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(startPoint)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">		// Assign values to new C.User struct</span></span>
<span class="line"><span style="color:#E1E4E8">		currentUser.name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(user.name)</span></span>
<span class="line"><span style="color:#E1E4E8">		currentUser.age </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">int</span><span style="color:#E1E4E8">(user.age)</span></span>
<span class="line"><span style="color:#E1E4E8">		currentUser.email </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> C.</span><span style="color:#B392F0">CString</span><span style="color:#E1E4E8">(user.email)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> users</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_user</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_user</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userReference</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.name))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference.email))</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(userReference))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//export free_users</span></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> free_users</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">users</span><span style="color:#F97583"> *</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">count</span><span style="color:#B392F0"> C</span><span style="color:#E1E4E8">.</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">(count) {</span></span>
<span class="line"><span style="color:#E1E4E8">		currentUserPointer </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">)(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(users)) </span><span style="color:#F97583">+</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(i)</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">unsafe.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">C</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">User</span><span style="color:#E1E4E8">{})))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">		// Clear strings</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(currentUserPointer.name))</span></span>
<span class="line"><span style="color:#E1E4E8">		C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(currentUserPointer.email))</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">	C.</span><span style="color:#B392F0">free</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(users))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">	// Do nothing</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>testing.py</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> traceback</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> dataclasses </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> dataclass</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> platform </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> platform</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> ctypes </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> cdll, c_char_p, c_int, </span><span style="color:#79B8FF">POINTER</span><span style="color:#E1E4E8">, Structure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># import library</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> platform().lower().startswith(</span><span style="color:#9ECBFF">"windows"</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.dll"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cdll.LoadLibrary(</span><span style="color:#9ECBFF">"./lib.so"</span><span style="color:#E1E4E8">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Setup functions</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.fib_sequence.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(c_int)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_int_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.multiply_string.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p, c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.multiply_string.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(c_char_p)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_string_array.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(c_char_p), c_int]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">n </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#E1E4E8">ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.fib_sequence(n)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(n):</span></span>
<span class="line"><span style="color:#E1E4E8">        results.append(ptr[i])</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(results)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_int_array(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"><span style="color:#E1E4E8">r </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.multiply_string(</span><span style="color:#9ECBFF">"Hello"</span><span style="color:#E1E4E8">.encode(), count)</span></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#E1E4E8">        result.append(r[i].decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">'replace'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(result)</span></span>
<span class="line"><span style="color:#F97583">finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    lib.free_string_array(r, count)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># User demo</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CUser</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Structure</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#E1E4E8">    _fields_ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"age"</span><span style="color:#E1E4E8">, c_int),</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#9ECBFF">"email"</span><span style="color:#E1E4E8">, c_char_p),</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(CUser)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_random_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_char_p, c_int, c_char_p]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.create_user.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.create_random_users.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [c_int]</span></span>
<span class="line"><span style="color:#E1E4E8">lib.create_random_users.restype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> POINTER(CUser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">lib.free_users.argtypes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [POINTER(CUser), c_int]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">@dataclass</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> User</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    name:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    age:</span><span style="color:#79B8FF">int</span></span>
<span class="line"><span style="color:#E1E4E8">    email:</span><span style="color:#79B8FF">str</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_user_from_C</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">, name:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">, age:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">, email:</span><span style="color:#79B8FF">str</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_user(name.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">), age, email.encode(</span><span style="color:#FFAB70">encoding</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"utf-8"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.name.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> name</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.age </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> age</span></span>
<span class="line"><span style="color:#F97583">            assert</span><span style="color:#E1E4E8"> data.email.decode() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> email</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Something went wrong, free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_random_user</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">) -> </span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_random_user()</span></span>
<span class="line"><span style="color:#E1E4E8">        data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer.contents</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> User(data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">), data.age, data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        except</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">AssertionError</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">UnicodeDecodeError</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> e:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Could not instantiate User</span><span style="color:#79B8FF">\n\t{repr</span><span style="color:#E1E4E8">(traceback.format_exception(e))</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">            # Something went wrong, free the memory</span></span>
<span class="line"><span style="color:#E1E4E8">            lib.free_user(pointer)</span></span>
<span class="line"><span style="color:#E1E4E8">            </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">classmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> create_random_users</span><span style="color:#E1E4E8">(cls:</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">, count:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">) -> list[</span><span style="color:#9ECBFF">'User'</span><span style="color:#E1E4E8">]:</span></span>
<span class="line"><span style="color:#E1E4E8">        results </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#E1E4E8">        pointer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lib.create_random_users(count)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> pointer:</span></span>
<span class="line"><span style="color:#F97583">            raise</span><span style="color:#79B8FF"> ValueError</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Failed to parse URLs"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">            for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#E1E4E8">(count):</span></span>
<span class="line"><span style="color:#E1E4E8">                site_ptr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pointer[i]</span></span>
<span class="line"><span style="color:#E1E4E8">                data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> site_ptr</span></span>
<span class="line"><span style="color:#E1E4E8">                </span></span>
<span class="line"><span style="color:#F97583">                try</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">                    results.append(</span><span style="color:#79B8FF">cls</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">                        name</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.name.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                        age</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.age,</span></span>
<span class="line"><span style="color:#FFAB70">                        email</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">data.email.decode(</span><span style="color:#FFAB70">errors</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"replace"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">                    ))</span></span>
<span class="line"><span style="color:#F97583">                except</span><span style="color:#79B8FF"> AttributeError</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">                    continue</span><span style="color:#6A737D"> # No data</span></span>
<span class="line"><span style="color:#F97583">        finally</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">            cls</span><span style="color:#E1E4E8">.free_sites(pointer[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">],count )</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> results</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#B392F0">    @</span><span style="color:#79B8FF">staticmethod</span></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> free_sites</span><span style="color:#E1E4E8">(array_pointer: CUser, count:</span><span style="color:#79B8FF">int</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> array_pointer:</span></span>
<span class="line"><span style="color:#F97583">            return</span></span>
<span class="line"><span style="color:#E1E4E8">        lib.free_users(array_pointer, count)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">users </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> User.create_random_users(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(users)</span></span></code></pre>
</details>
<h2 id="conclusions">Conclusions</h2>
<p>It‚Äôs over, I‚Äôm free, almost. This was one of the longest slogs I‚Äôve had programming. It isn‚Äôt for the faint of heart, but it‚Äôs great when it‚Äôs done. This article gave you everything you need to start working with a process like this, and in the <a href="https://kieranwood.ca/tech/blog/python-plus-go-examples">next article</a>. I will show you some real world demos of this in action, as well as some of the higher level practical tips.</p>
<h2 id="references">References</h2>
<ul>
<li>CGO
<ul>
<li><a href="https://github.com/golang/go/wiki/cgo/3c9c9e1adea9cc62389ba8adab07986c00060fe8">cgo intro</a></li>
<li><a href="https://go.dev/wiki/cgo">CGO wiki</a></li>
<li><a href="https://golangbot.com/types/">Data types</a></li>
<li><a href="https://gist.github.com/zchee/b9c99695463d8902cd33">General notes</a></li>
<li><a href="https://blog.marlin.org/cgo-referencing-c-library-in-go">https://blog.marlin.org/cgo-referencing-c-library-in-go</a></li>
<li><a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoCGoStringFunctions">Cgo Strings</a></li>
</ul>
</li>
<li>Ctypes
<ul>
<li><a href="https://docs.python.org/3/library/ctypes.html">docs</a></li>
</ul>
</li>
<li>Shared Libraries
<ul>
<li><a href="https://ericchiang.github.io/post/rust-libs/">Shared libs in rust</a></li>
</ul>
</li>
</ul>  </article> </main> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js" integrity="sha256-mm3Re3y7xlvh+yCD+l/Zs1d+PU0AEad93MkWvljfm/s=" crossorigin="anonymous"></script> <script type="module">mermaid.initialize({securityLevel:"loose",theme:"dark"});</script>  </main> </div> <footer class="footer footer-center block mb-5 pt-10"> <div class="pb-2">
&copy; 2026 Kieran Wood
</div> <div class="inline opacity-75"> <!-- Thanks for using this template. You can keep this line to support my work :) --> <a href="https://astrofy-template.netlify.app/" target="_blank" class="font-bold">Astrofy Template</a> developed by
<a href="https://manuelernestog.github.io" target="_blank" class="font-bold">Manuel Ernesto ‚ö°Ô∏è</a> </div> </footer>  </div> <div class="drawer-side z-40"> <label for="my-drawer" class="drawer-overlay"></label> <aside class="px-2 pt-2 h-auto min-h-full w-[19rem] bg-base-200 text-base-content flex flex-col"> <div class="w-fit mx-auto mt-5 mb-6"> <a href="/"> <div class="avatar transition ease-in-out hover:scale-[102%] block m-auto"> <div class="w-[8.5rem]"> <img src="/tech/profile.jpg" alt="Profile image" loading="lazy" decoding="async" fetchpriority="auto" width="300" height="300" class="mask mask-circle"> </div> </div> </a> </div> <ul class="menu grow shrink menu-md overflow-y-auto"> <li><a class="py-3 text-base" id="home" href="/tech/">Home</a></li> <li><a class="py-3 text-base" id="projects" href="/tech/projects">Projects</a></li> <!-- <li><a class="py-3 text-base" id="services" href="/tech/services">Services</a></li>
    <li><a class="py-3 text-base" id="store" href="/tech/store">Store</a></li> --> <li><a class="py-3 text-base" id="blog" href="/tech/blog/">Blog</a></li> <li><a class="py-3 text-base" id="cv" href="/tech/cv">CV</a></li> <li><a class="py-3 text-base" href="/tech/contact">Contact</a></li> </ul> <script>(function(){const sideBarActiveItemID = undefined;
const activeClass = "bg-base-300";

const activeItemElem = document.getElementById(sideBarActiveItemID);
activeItemElem && activeItemElem.classList.add(activeClass);
})();</script> <div class="block sticky pointer-events-none bottom-10 bg-base-200 justify-center h-12 [mask-image:linear-gradient(transparent,#000000)]"></div> <div class="social-icons px-4 pb-5 pt-1 flex self-center justify-center sticky bottom-0 bg-base-200"> <a href="https://github.com/descent098" target="_blank" class="mx-3" aria-label="Github" title="Github"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"></path> </svg> </a> <a href="https://www.linkedin.com/in/kieran-wood" target="_blank" class="mx-3" aria-label="Linkedin" title="Linkedin"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><circle cx="4.983" cy="5.009" r="2.188"></circle><path d="M9.237 8.855v12.139h3.769v-6.003c0-1.584.298-3.118 2.262-3.118 1.937 0 1.961 1.811 1.961 3.218v5.904H21v-6.657c0-3.27-.704-5.783-4.526-5.783-1.835 0-3.065 1.007-3.568 1.96h-.051v-1.66H9.237zm-6.142 0H6.87v12.139H3.095z"></path> </svg> </a> <a href="https://instagram.com/descent098" target="_blank" class="mx-3" aria-label="Instagram" title="Instagram"> <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 -5 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"></path> </svg> </a> <a href="/rss.xml" target="_blank" class="mx-3" aria-label="RSS Feed" title="RSS Feed"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19 20.001C19 11.729 12.271 5 4 5v2c7.168 0 13 5.832 13 13.001h2z"></path><path d="M12 20.001h2C14 14.486 9.514 10 4 10v2c4.411 0 8 3.589 8 8.001z"></path><circle cx="6" cy="18" r="2"></circle> </svg> </a> </div> </aside> </div> </div> </body></html>